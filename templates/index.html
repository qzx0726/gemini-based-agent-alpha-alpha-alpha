<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªä¸»ä»»åŠ¡å®Œæˆä»£ç† (é‡æ„ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-block { border-left: 2px solid #e5e7eb; padding-left: 1rem; margin-bottom: 1rem; }
        .task-list-item { transition: all 0.3s ease; }
        .task-list-item.status-pending { border-left-color: #9ca3af; }
        .task-list-item.status-running { border-left-color: #3b82f6; background-color: #eff6ff; }
        .task-list-item.status-completed { border-left-color: #22c55e; }
        .task-list-item.status-failed { border-left-color: #ef4444; background-color: #fef2f2; }
        .log-entry { transition: opacity 0.5s ease; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #serverStatus { transition: all 0.3s ease; }
        #confirmationModal, #settingsModal { transition: opacity 0.3s ease; }
        .settings-button { position: absolute; top: 1rem; right: 1rem; z-index: 10; }
        .code-editor { 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
            border-radius: 6px; 
            padding: 12px; 
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .code-output {
            background-color: #f5f5f5;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .tool-chain {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .tool-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .tool-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .tool-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            color: white;
        }
        .tool-icon.write { background-color: #4CAF50; }
        .tool-icon.debug { background-color: #FF9800; }
        .tool-icon.run { background-color: #2196F3; }
        .tool-icon.save { background-color: #9C27B0; }
        .tool-icon.think { background-color: #607D8B; }
        .tool-icon.command { background-color: #795548; }
        .tool-content {
            flex-grow: 1;
        }
        .tool-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .saved-codes {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 8px;
            background-color: #f9f9f9;
        }
        .saved-code-item {
            padding: 8px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .saved-code-item:hover {
            background-color: #f0f0f0;
        }
        .saved-code-item.selected {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
        }
        .custom-model-input {
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
        }
        .api-status {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .api-status.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .api-status.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .api-status.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .final-report {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
        }
        .final-report h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .final-report-content {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8 relative">
            <button id="settingsButton" class="settings-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-300 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379-1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
            </button>
            <div class="flex justify-center items-center gap-2 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">è‡ªä¸»ä»»åŠ¡å®Œæˆä»£ç†</h1>
                <span id="serverStatus" class="h-4 w-4 rounded-full bg-red-500" title="æœªè¿æ¥åˆ°å·¥å…·æœåŠ¡å™¨"></span>
            </div>
            <p class="mt-2 text-gray-600">Gemini æ¨¡å‹é©±åŠ¨ï¼Œæ”¯æŒä»»åŠ¡æ‹†åˆ†ã€æ‰§è¡Œä¸å®¡é˜…ã€‚</p>
        </header>
        
        <div id="apiStatusContainer"></div>
        
        <div class="mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
            <p class="font-bold">âš ï¸ å®‰å…¨è­¦å‘Š</p>
            <p>æ‚¨çš„ Gemini API Key å°†ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ç”¨äºè°ƒç”¨APIã€‚è¯·å‹¿åœ¨å…¬å…±ç½‘ç«™æˆ–ä¸å—ä¿¡ä»»çš„ç¯å¢ƒä¸­ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¼šæš´éœ²æ‚¨çš„å¯†é’¥ã€‚æ­¤æ–¹æ³•ä»…é€‚ç”¨äºæœ¬åœ°å¼€å‘æˆ–ä¸ªäººé¡¹ç›®ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ Gemini API Key" class="mt-2 w-full p-2 border border-red-300 rounded-md focus:ring-2 focus:ring-red-500 focus:outline-none">
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="mainTaskInput" placeholder="ä¾‹å¦‚ï¼šåˆ†æä¸€ä¸ªCSVæ–‡ä»¶ä¸­çš„é”€å”®æ•°æ®å¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="startButton" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="buttonText">å¼€å§‹ä»»åŠ¡</span>
                    <div id="buttonLoader" class="loader ml-2 hidden"></div>
                </button>
            </div>
        </div>
        
        <div id="results" class="space-y-8">
            <section id="planSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ä»»åŠ¡è®¡åˆ’</h2>
                <div id="planContainer"></div>
            </section>
            
            <section id="executionSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">æ‰§è¡Œè¿‡ç¨‹</h2>
                <div id="executionContainer"></div>
            </section>
            
            <section id="logSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">æ‰§è¡Œæ—¥å¿—</h2>
                <div id="logContainer" class="p-4 bg-gray-900 text-white rounded-md font-mono text-sm max-h-96 overflow-y-auto space-y-2"></div>
            </section>
            
            <section id="savedCodesSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">å·²ä¿å­˜çš„ä»£ç </h2>
                <div class="mb-4">
                    <button id="refreshSavedCodesBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                        åˆ·æ–°ä»£ç åˆ—è¡¨
                    </button>
                </div>
                <div id="savedCodesContainer" class="saved-codes"></div>
            </section>
            
            <section id="finalResultSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">æœ€ç»ˆæˆæœ</h2>
                <div id="finalResultContainer" class="p-6 bg-white rounded-lg shadow prose max-w-none"></div>
            </section>
            
            <section id="finalReportSection" class="hidden">
                <div class="final-report">
                    <h2>ğŸ“Š ä»»åŠ¡å®ŒæˆæŠ¥å‘Š</h2>
                    <div id="finalReportContent" class="final-report-content"></div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"><svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg></div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">éœ€è¦ä½ çš„ç¡®è®¤</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Agent æè®®æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
                    <div id="modalContent" class="mt-2 text-left bg-gray-100 p-3 rounded-md">
                        <p><strong>å·¥å…·:</strong> <code id="modalTool" class="text-red-500 font-semibold"></code></p>
                        <p><strong>è¾“å…¥:</strong></p>
                        <pre id="modalQuery" class="whitespace-pre-wrap text-sm bg-gray-800 text-white p-2 rounded mt-1 max-h-40 overflow-y-auto"></pre>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="approveBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">æ‰¹å‡†</button>
                    <button id="rejectBtn" class="mt-3 px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">æ‹’ç»</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">è®¾ç½®</h3>
                    <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-base font-medium text-gray-900">è‡ªåŠ¨æ‰¹å‡†</h4>
                            <p class="text-sm text-gray-500">å¯ç”¨åå°†è‡ªåŠ¨æ‰¹å‡†æ‰€æœ‰å·¥å…·ä½¿ç”¨è¯·æ±‚</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoApproveToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-base font-medium text-gray-900">æ¨¡å‹é€‰æ‹©</h4>
                        <div>
                            <label for="planningModel" class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡è§„åˆ’æ¨¡å‹</label>
                            <select id="planningModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (æ¨è)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                            </select>
                            <input type="text" id="customPlanningModel" class="custom-model-input hidden" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼Œå¦‚: gemini-1.5-flash-latest">
                        </div>
                        <div>
                            <label for="executionModel" class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡æ‰§è¡Œæ¨¡å‹</label>
                            <select id="executionModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (æ¨è)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                            </select>
                            <input type="text" id="customExecutionModel" class="custom-model-input hidden" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼Œå¦‚: gemini-1.5-flash-latest">
                        </div>
                        <div>
                            <label for="reviewModel" class="block text-sm font-medium text-gray-700 mb-1">ç»“æœå®¡é˜…æ¨¡å‹</label>
                            <select id="reviewModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (æ¨è)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                            </select>
                            <input type="text" id="customReviewModel" class="custom-model-input hidden" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼Œå¦‚: gemini-1.5-flash-latest">
                        </div>
                        <div>
                            <label for="outputModel" class="block text-sm font-medium text-gray-700 mb-1">è¾“å‡ºæ€»ç»“æ¨¡å‹</label>
                            <select id="outputModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (æ¨è)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">è‡ªå®šä¹‰æ¨¡å‹</option>
                            </select>
                            <input type="text" id="customOutputModel" class="custom-model-input hidden" placeholder="è¾“å…¥è‡ªå®šä¹‰æ¨¡å‹åç§°ï¼Œå¦‚: gemini-1.5-flash-latest">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-base font-medium text-gray-900">APIè®¾ç½®</h4>
                        <div>
                            <label for="apiRequestDelay" class="block text-sm font-medium text-gray-700 mb-1">APIè¯·æ±‚é—´éš”(ç§’)</label>
                            <input type="number" id="apiRequestDelay" min="1" max="60" value="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">å¢åŠ æ­¤å€¼å¯ä»¥é¿å…APIé€Ÿç‡é™åˆ¶é”™è¯¯</p>
                        </div>
                        <div>
                            <label for="maxRetries" class="block text-sm font-medium text-gray-700 mb-1">æœ€å¤§é‡è¯•æ¬¡æ•°</label>
                            <input type="number" id="maxRetries" min="1" max="10" value="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="saveSettingsBtn" class="w-full px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- [FIX] Wrap all code in DOMContentLoaded listener to ensure libraries are loaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM å…ƒç´  ---
            const apiKeyInput = document.getElementById('apiKeyInput');
            const mainTaskInput = document.getElementById('mainTaskInput');
            const startButton = document.getElementById('startButton');
            const buttonText = document.getElementById('buttonText');
            const buttonLoader = document.getElementById('buttonLoader');
            const serverStatus = document.getElementById('serverStatus');
            const planSection = document.getElementById('planSection');
            const planContainer = document.getElementById('planContainer');
            const executionSection = document.getElementById('executionSection');
            const executionContainer = document.getElementById('executionContainer');
            const logSection = document.getElementById('logSection');
            const logContainer = document.getElementById('logContainer');
            const savedCodesSection = document.getElementById('savedCodesSection');
            const savedCodesContainer = document.getElementById('savedCodesContainer');
            const refreshSavedCodesBtn = document.getElementById('refreshSavedCodesBtn');
            const finalResultSection = document.getElementById('finalResultSection');
            const finalResultContainer = document.getElementById('finalResultContainer');
            const finalReportSection = document.getElementById('finalReportSection');
            const finalReportContent = document.getElementById('finalReportContent');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalTool = document.getElementById('modalTool');
            const modalQuery = document.getElementById('modalQuery');
            const approveBtn = document.getElementById('approveBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const settingsButton = document.getElementById('settingsButton');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const autoApproveToggle = document.getElementById('autoApproveToggle');
            const planningModel = document.getElementById('planningModel');
            const executionModel = document.getElementById('executionModel');
            const reviewModel = document.getElementById('reviewModel');
            const outputModel = document.getElementById('outputModel');
            const customPlanningModel = document.getElementById('customPlanningModel');
            const customExecutionModel = document.getElementById('customExecutionModel');
            const customReviewModel = document.getElementById('customReviewModel');
            const customOutputModel = document.getElementById('customOutputModel');
            const apiRequestDelay = document.getElementById('apiRequestDelay');
            const maxRetries = document.getElementById('maxRetries');
            const apiStatusContainer = document.getElementById('apiStatusContainer');
            
            // --- çŠ¶æ€ç®¡ç† ---
            let state = {};
            const toolResponses = new Map();
            let modalResolver = null;
            let savedCodes = {}; // ä¿å­˜çš„ä»£ç 
            let selectedCodeId = null; // å½“å‰é€‰ä¸­çš„ä»£ç ID
            let apiCallCount = 0; // APIè°ƒç”¨è®¡æ•°
            let lastApiCallTime = 0; // ä¸Šæ¬¡APIè°ƒç”¨æ—¶é—´
            let apiErrorCount = 0; // APIé”™è¯¯è®¡æ•°
            let executionHistory = []; // å­˜å‚¨æ¯ä¸ªä»»åŠ¡çš„æ‰§è¡Œå†å²
            
            // --- é»˜è®¤æ¨¡å‹ç»„è®¾ä¸º gemini-2.0 ç³»åˆ— ---
            let settings = {
                autoApprove: false,
                planningModel: 'gemini-2.0-flash-exp',
                executionModel: 'gemini-2.0-flash-exp',
                reviewModel: 'gemini-2.0-flash-exp',
                outputModel: 'gemini-2.0-flash-exp',
                customPlanningModel: '',
                customExecutionModel: '',
                customReviewModel: '',
                customOutputModel: '',
                apiRequestDelay: 6, // é»˜è®¤6ç§’é—´éš”
                maxRetries: 3 // é»˜è®¤æœ€å¤§é‡è¯•3æ¬¡
            };
            
            function loadSettings() {
                const savedSettings = localStorage.getItem('agentSettings');
                if (savedSettings) {
                    try {
                        settings = JSON.parse(savedSettings);
                        autoApproveToggle.checked = settings.autoApprove;
                        
                        // è®¾ç½®è§„åˆ’æ¨¡å‹
                        if (settings.customPlanningModel) {
                            planningModel.value = 'custom';
                            customPlanningModel.value = settings.customPlanningModel;
                            customPlanningModel.classList.remove('hidden');
                        } else {
                            planningModel.value = settings.planningModel;
                        }
                        
                        // è®¾ç½®æ‰§è¡Œæ¨¡å‹
                        if (settings.customExecutionModel) {
                            executionModel.value = 'custom';
                            customExecutionModel.value = settings.customExecutionModel;
                            customExecutionModel.classList.remove('hidden');
                        } else {
                            executionModel.value = settings.executionModel;
                        }
                        
                        // è®¾ç½®å®¡é˜…æ¨¡å‹
                        if (settings.customReviewModel) {
                            reviewModel.value = 'custom';
                            customReviewModel.value = settings.customReviewModel;
                            customReviewModel.classList.remove('hidden');
                        } else {
                            reviewModel.value = settings.reviewModel;
                        }
                        
                        // è®¾ç½®è¾“å‡ºæ¨¡å‹
                        if (settings.customOutputModel) {
                            outputModel.value = 'custom';
                            customOutputModel.value = settings.customOutputModel;
                            customOutputModel.classList.remove('hidden');
                        } else {
                            outputModel.value = settings.outputModel || 'gemini-2.0-flash-exp';
                        }
                        
                        // è®¾ç½®APIå‚æ•°
                        apiRequestDelay.value = settings.apiRequestDelay || 6;
                        maxRetries.value = settings.maxRetries || 3;
                    } catch (e) { console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e); }
                }
            }
            
            function saveSettings() {
                settings.autoApprove = autoApproveToggle.checked;
                
                // ä¿å­˜è§„åˆ’æ¨¡å‹
                if (planningModel.value === 'custom') {
                    settings.customPlanningModel = customPlanningModel.value;
                    settings.planningModel = '';
                } else {
                    settings.planningModel = planningModel.value;
                    settings.customPlanningModel = '';
                }
                
                // ä¿å­˜æ‰§è¡Œæ¨¡å‹
                if (executionModel.value === 'custom') {
                    settings.customExecutionModel = customExecutionModel.value;
                    settings.executionModel = '';
                } else {
                    settings.executionModel = executionModel.value;
                    settings.customExecutionModel = '';
                }
                
                // ä¿å­˜å®¡é˜…æ¨¡å‹
                if (reviewModel.value === 'custom') {
                    settings.customReviewModel = customReviewModel.value;
                    settings.reviewModel = '';
                } else {
                    settings.reviewModel = reviewModel.value;
                    settings.customReviewModel = '';
                }
                
                // ä¿å­˜è¾“å‡ºæ¨¡å‹
                if (outputModel.value === 'custom') {
                    settings.customOutputModel = customOutputModel.value;
                    settings.outputModel = '';
                } else {
                    settings.outputModel = outputModel.value;
                    settings.customOutputModel = '';
                }
                
                // ä¿å­˜APIå‚æ•°
                settings.apiRequestDelay = parseInt(apiRequestDelay.value) || 6;
                settings.maxRetries = parseInt(maxRetries.value) || 3;
                
                localStorage.setItem('agentSettings', JSON.stringify(settings));
            }
            
            function getModelName(selectElement, customInput) {
                if (selectElement.value === 'custom') {
                    return customInput.value || 'gemini-2.0-flash-exp';
                }
                return selectElement.value;
            }
            
            // æ˜¾ç¤ºAPIçŠ¶æ€
            function showApiStatus(message, type = 'warning') {
                apiStatusContainer.innerHTML = `
                    <div class="api-status ${type}">
                        ${message}
                    </div>
                `;
                
                // 5ç§’åè‡ªåŠ¨éšè—
                setTimeout(() => {
                    apiStatusContainer.innerHTML = '';
                }, 5000);
            }
            
            // --- WebSocket è¿æ¥ (ä»…ç”¨äºå·¥å…·æœåŠ¡å™¨) ---
            const socket = io("http://127.0.0.1:5000");
            socket.on('connect', () => {
                serverStatus.classList.remove('bg-red-500');
                serverStatus.classList.add('bg-green-500');
                serverStatus.title = "å·²è¿æ¥åˆ°å·¥å…·æœåŠ¡å™¨";
            });
            socket.on('disconnect', () => {
                serverStatus.classList.remove('bg-green-500');
                serverStatus.classList.add('bg-red-500');
                serverStatus.title = "æœªè¿æ¥åˆ°å·¥å…·æœåŠ¡å™¨";
            });
            socket.on('tool_result', (data) => {
                const resolver = toolResponses.get(data.request_id);
                if (resolver) {
                    resolver(data);
                    toolResponses.delete(data.request_id);
                }
            });
            
            // --- æ ¸å¿ƒ Agent é€»è¾‘ ---
            async function runAgent() {
                if (state.isBusy) return;
                initializeState();
                if (!validateInputs()) return;
                setBusy(true);
                try {
                    await logStep("1. å¼€å§‹åˆ†æä»»åŠ¡å¹¶æ‹†åˆ†ä¸ºåˆ‡å®å¯è¡Œçš„ä»»åŠ¡å—...", "ğŸ§ ");
                    const plan = await decomposeTask(state.mainTask);
                    if (!Array.isArray(plan) || plan.length === 0) {
                        await logStep("è§£æåˆ°çš„è®¡åˆ’ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„ï¼Œç»ˆæ­¢æ‰§è¡Œã€‚", "âŒ");
                        throw new Error("è§£æåˆ°çš„è®¡åˆ’ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„ã€‚æ£€æŸ¥æ¨¡å‹è¿”å›åŸæ–‡ä»¥å®šä½é—®é¢˜ã€‚");
                    }
                    state.plan = plan;
                    displayPlan();
                    await logStep(`   è®¡åˆ’åˆ¶å®šå®Œæ¯•ï¼Œå…± ${plan.length} ä¸ªä»»åŠ¡å—ã€‚`, "âœ…");
                    
                    // ä¾æ¬¡æ‰§è¡Œæ¯ä¸ªä»»åŠ¡å—
                    for (let taskIndex = 0; taskIndex < state.plan.length; taskIndex++) {
                        const task = state.plan[taskIndex];
                        const result = await executeTaskBlock(task, taskIndex);
                        
                        // æ£€æŸ¥æ˜¯å¦é‡æ–°è§„åˆ’äº†
                        if (result && result.replanned) {
                            // é‡ç½®ä»»åŠ¡ç´¢å¼•ï¼Œé‡æ–°å¼€å§‹æ‰§è¡Œ
                            taskIndex = -1;
                            await logStep(`é‡æ–°è§„åˆ’å®Œæˆï¼Œä»ç¬¬ä¸€ä¸ªä»»åŠ¡å¼€å§‹æ‰§è¡Œ`, "ğŸ”„");
                            continue;
                        }
                    }
                    
                    await finalizeTask();
                } catch (error) {
                    await handleFatalError(error);
                }
            }
            
            async function executeTaskBlock(task, taskIndex) {
                const taskId = `task-${taskIndex}`;
                updateTaskStatus(taskId, 'running');
                await logStep(`\nå¼€å§‹æ‰§è¡Œä»»åŠ¡å— #${taskIndex + 1}: "${task}"`, "ğŸš€");
                
                // åˆ›å»ºæ‰§è¡Œè¿‡ç¨‹æ˜¾ç¤ºåŒºåŸŸ
                const executionDiv = createExecutionDisplay(taskIndex, task);
                executionContainer.appendChild(executionDiv);
                executionSection.classList.remove('hidden');
                
                const maxRetriesCount = parseInt(settings.maxRetries) || 3;
                let lastOutput = '';
                let lastFeedback = '';
                let taskExecutionHistory = {
                    taskIndex,
                    task,
                    toolChain: [],
                    output: '',
                    status: 'running'
                };
                
                for (let retryCount = 0; retryCount <= maxRetriesCount; retryCount++) {
                    if (retryCount > 0) {
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ç¬¬ ${retryCount} æ¬¡å°è¯•ä¿®æ­£...`, "ğŸ› ï¸");
                    }
                    try {
                        // æ‰§è¡ŒAIå†³ç­–å¹¶æ‰§è¡Œ
                        const result = await executeAITask(task, taskIndex, retryCount, executionDiv, taskExecutionHistory);
                        
                        // æ£€æŸ¥æ˜¯å¦é‡æ–°è§„åˆ’äº†
                        if (result.replanned) {
                            // é‡æ–°å¼€å§‹æ‰§è¡Œæ•´ä¸ªä»»åŠ¡
                            await logStep(`ä»»åŠ¡å·²é‡æ–°è§„åˆ’ï¼Œé‡æ–°å¼€å§‹æ‰§è¡Œ...`, "ğŸ”„");
                            return { replanned: true, newPlan: result.newPlan };
                        }
                        
                        lastOutput = result.output;
                        taskExecutionHistory.output = result.output;
                        
                        // å®¡é˜…AIè¯„ä¼°ç»“æœ
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] äº¤ç»™å®¡é˜…AIè¯„ä¼°...`, "ğŸ§");
                        const reviewResult = await reviewTaskResult(task, result.output);
                        
                        if (reviewResult.passed) {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] å®¡é˜…é€šè¿‡ï¼`, "âœ…");
                            state.completedOutputs.push({ task, output: result.output });
                            taskExecutionHistory.status = 'completed';
                            updateTaskStatus(taskId, 'completed');
                            updateExecutionDisplay(executionDiv, 'completed', result.output);
                            executionHistory.push(taskExecutionHistory);
                            return;
                        } else {
                            lastFeedback = reviewResult.feedback;
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] å®¡é˜…ä¸é€šè¿‡ã€‚åé¦ˆ: ${lastFeedback}`, "ğŸ‘");
                            updateExecutionDisplay(executionDiv, 'failed', result.output, lastFeedback);
                            
                            if (retryCount >= maxRetriesCount) {
                                taskExecutionHistory.status = 'failed';
                                taskExecutionHistory.error = lastFeedback;
                                executionHistory.push(taskExecutionHistory);
                                throw new Error(`ä»»åŠ¡ "${task}" åœ¨ ${maxRetriesCount} æ¬¡é‡è¯•åä»ç„¶æœªé€šè¿‡å®¡é˜…ã€‚`);
                            }
                        }
                    } catch (error) {
                        console.error(`ä»»åŠ¡ ${taskIndex + 1} æ‰§è¡Œé”™è¯¯:`, error);
                        const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡Œé”™è¯¯: ${errorMessage}`, "âŒ");
                        lastFeedback = `æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ${errorMessage}`;
                        lastOutput = `[å¼‚å¸¸] ${errorMessage}`;
                        
                        if (retryCount >= maxRetriesCount) {
                            taskExecutionHistory.status = 'failed';
                            taskExecutionHistory.error = errorMessage;
                            executionHistory.push(taskExecutionHistory);
                            updateTaskStatus(taskId, 'failed');
                            updateExecutionDisplay(executionDiv, 'failed', lastOutput, lastFeedback);
                            throw error;
                        }
                    }
                }
                
                taskExecutionHistory.status = 'failed';
                taskExecutionHistory.error = lastFeedback;
                executionHistory.push(taskExecutionHistory);
                updateTaskStatus(taskId, 'failed');
                updateExecutionDisplay(executionDiv, 'failed', lastOutput, lastFeedback);
                throw new Error(`ä»»åŠ¡ "${task}" åœ¨ ${maxRetriesCount} æ¬¡é‡è¯•åä»ç„¶å¤±è´¥ã€‚`);
            }
            
            async function executeAITask(task, taskIndex, retryCount, executionDiv, taskExecutionHistory) {
                await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIå¼€å§‹å¤„ç†...`, "ğŸ¤–");
                
                let currentCode = '';
                let toolChain = [];
                let isCompleted = false;
                let result = '';
                
                while (!isCompleted) {
                    // æ‰§è¡ŒAIå†³ç­–
                    const decision = await makeExecutionDecision(task, currentCode, toolChain, retryCount);
                    toolChain.push(decision);
                    taskExecutionHistory.toolChain.push(decision);
                    
                    // æ˜¾ç¤ºå·¥å…·é“¾æ­¥éª¤
                    addToolChainStep(executionDiv, decision);
                    
                    if (decision.action === 'think') {
                        // ç›´æ¥æ€è€ƒè¾“å‡º
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIç›´æ¥æ€è€ƒè¾“å‡º...`, "ğŸ’­");
                        result = decision.output;
                        isCompleted = true;
                    } else if (decision.action === 'replan') {
                        // é‡æ–°è§„åˆ’ä»»åŠ¡
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] AIå†³å®šé‡æ–°è§„åˆ’ä»»åŠ¡...`, "ğŸ”„");
                        
                        if (decision.newPlan && Array.isArray(decision.newPlan)) {
                            // æ›´æ–°ä»»åŠ¡è®¡åˆ’
                            state.plan = decision.newPlan;
                            displayPlan();
                            
                            // é‡æ–°å¼€å§‹æ‰§è¡Œ
                            await logStep(`ä»»åŠ¡å·²é‡æ–°è§„åˆ’ï¼Œå…± ${decision.newPlan.length} ä¸ªä»»åŠ¡å—`, "âœ…");
                            
                            // è¿”å›ç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºéœ€è¦é‡æ–°å¼€å§‹
                            return { 
                                output: 'ä»»åŠ¡å·²é‡æ–°è§„åˆ’', 
                                toolChain,
                                replanned: true,
                                newPlan: decision.newPlan
                            };
                        } else {
                            await logStep(`é‡æ–°è§„åˆ’å¤±è´¥ï¼šæœªæä¾›æœ‰æ•ˆçš„æ–°è®¡åˆ’`, "âŒ");
                        }
                    } else if (decision.action === 'write_code') {
                        // ç¼–å†™ä»£ç 
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIç¼–å†™ä»£ç ...`, "ğŸ“");
                        currentCode = decision.code;
                    } else if (decision.action === 'debug_code') {
                        // è°ƒè¯•ä»£ç 
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIè°ƒè¯•ä»£ç ...`, "ğŸ›");
                        currentCode = decision.code;
                    } else if (decision.action === 'run_code') {
                        // è¿è¡Œä»£ç 
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIè¿è¡Œä»£ç ...`, "â–¶ï¸");
                        const runResult = await runPythonCode(currentCode);
                        decision.runResult = runResult;
                        
                        // æ›´æ–°å·¥å…·é“¾æ˜¾ç¤º
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (runResult.error) {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ä»£ç è¿è¡Œå‡ºé”™: ${runResult.error}`, "âŒ");
                        } else {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ä»£ç è¿è¡ŒæˆåŠŸ`, "âœ…");
                        }
                    } else if (decision.action === 'run_command') {
                        // è¿è¡Œå‘½ä»¤è¡Œ
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIè¿è¡Œå‘½ä»¤è¡Œ...`, "ğŸ’»");
                        const runResult = await runCommand(decision.command);
                        decision.runResult = runResult;
                        
                        // æ›´æ–°å·¥å…·é“¾æ˜¾ç¤º
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (runResult.error) {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] å‘½ä»¤è¡Œæ‰§è¡Œå‡ºé”™: ${runResult.error}`, "âŒ");
                        } else {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] å‘½ä»¤è¡Œæ‰§è¡ŒæˆåŠŸ`, "âœ…");
                        }
                    } else if (decision.action === 'save_code') {
                        // ä¿å­˜ä»£ç  - é€šè¿‡åç«¯API
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIä¿å­˜ä»£ç ...`, "ğŸ’¾");
                        const saveResult = await saveCodeToBackend(decision.name || `ä»£ç å—_${Date.now()}`, currentCode);
                        decision.saveResult = saveResult;
                        
                        // æ›´æ–°å·¥å…·é“¾æ˜¾ç¤º
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (saveResult.success) {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ä»£ç ä¿å­˜æˆåŠŸï¼ŒID: ${saveResult.codeId}`, "âœ…");
                            // åˆ·æ–°ä¿å­˜çš„ä»£ç åˆ—è¡¨
                            await loadSavedCodes();
                        } else {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ä»£ç ä¿å­˜å¤±è´¥: ${saveResult.error}`, "âŒ");
                        }
                    } else if (decision.action === 'run_saved_code') {
                        // è¿è¡Œå·²ä¿å­˜çš„ä»£ç  - é€šè¿‡åç«¯API
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIè¿è¡Œå·²ä¿å­˜çš„ä»£ç ...`, "ğŸ“‚");
                        const runResult = await runSavedCodeFromBackend(decision.codeId);
                        decision.runResult = runResult;
                        
                        // æ›´æ–°å·¥å…·é“¾æ˜¾ç¤º
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (runResult.success) {
                            if (runResult.error) {
                                await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ä»£ç è¿è¡Œå‡ºé”™: ${runResult.error}`, "âŒ");
                            } else {
                                await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] ä»£ç è¿è¡ŒæˆåŠŸ`, "âœ…");
                            }
                        } else {
                            await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ— æ³•è¿è¡Œä»£ç : ${runResult.error}`, "âŒ");
                        }
                    } else if (decision.action === 'complete') {
                        // å®Œæˆä»»åŠ¡
                        await logStep(`  [ä»»åŠ¡ ${taskIndex + 1}] æ‰§è¡ŒAIè®¤ä¸ºä»»åŠ¡å·²å®Œæˆ`, "ğŸ");
                        result = decision.output || currentCode;
                        isCompleted = true;
                    }
                }
                
                return { output: result, toolChain };
            }
            
            async function makeExecutionDecision(task, currentCode, toolChain, retryCount) {
                // é¦–å…ˆè·å–å·²ä¿å­˜çš„ä»£ç åˆ—è¡¨ï¼Œä»¥ä¾¿AIå†³ç­–
                const savedCodesList = await getSavedCodesList();
                
                const toolDescriptions = `
- think: ç›´æ¥æ€è€ƒå¹¶è¾“å‡ºç»“æœï¼Œä¸ä½¿ç”¨ä»»ä½•å·¥å…·
- write_code: ç¼–å†™æ–°çš„Pythonä»£ç 
- debug_code: è°ƒè¯•ç°æœ‰Pythonä»£ç 
- run_code: è¿è¡Œå½“å‰Pythonä»£ç 
- run_command: è¿è¡Œå‘½ä»¤è¡ŒæŒ‡ä»¤ï¼ˆå¦‚ls, dir, pip installç­‰ï¼‰
- save_code: ä¿å­˜å½“å‰ä»£ç åˆ°åç«¯
- run_saved_code: è¿è¡Œå·²ä¿å­˜çš„ä»£ç 
- replan: é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡ï¼ˆå½“å‘ç°å½“å‰è®¡åˆ’ä¸åˆé€‚æ—¶ï¼‰
- complete: è®¤ä¸ºä»»åŠ¡å·²å®Œæˆï¼Œè¾“å‡ºæœ€ç»ˆç»“æœ
`;
                
                const context = {
                    task,
                    currentCode: currentCode || 'æ— ',
                    toolChain: toolChain.map(step => ({
                        action: step.action,
                        input: step.input || '',
                        output: step.output || '',
                        runResult: step.runResult || null,
                        saveResult: step.saveResult || null
                    })),
                    retryCount,
                    savedCodes: savedCodesList
                };
                
                const prompt = `ä½ æ˜¯ä¸€ä¸ªæ‰§è¡ŒAIï¼Œè´Ÿè´£å®Œæˆå…·ä½“çš„ä»»åŠ¡å—ã€‚

å½“å‰ä»»åŠ¡: "${task}"

å½“å‰ä»£ç :
 ${currentCode || 'æ— '}

å·²æ‰§è¡Œçš„å·¥å…·é“¾:
 ${JSON.stringify(context.toolChain, null, 2)}

å·²ä¿å­˜çš„ä»£ç åˆ—è¡¨:
 ${JSON.stringify(context.savedCodes, null, 2)}

è¯·æ ¹æ®å½“å‰çŠ¶æ€ï¼Œå†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚å¯ç”¨å·¥å…·:
 ${toolDescriptions}

é‡è¦æç¤ºï¼š
1. å¦‚æœå‘ç°å½“å‰ä»»åŠ¡æ— æ³•å®Œæˆï¼Œæˆ–è€…éœ€è¦é‡æ–°è§„åˆ’æ•´ä¸ªä»»åŠ¡ï¼Œè¯·ä½¿ç”¨ replan å·¥å…·
2. é‡æ–°è§„åˆ’æ—¶ï¼Œè¯·ç»™å‡º"ç®€ç•¥ä½†ä¸ç®€é™‹"çš„è®¡åˆ’ - å³ç®€æ´ä½†åŒ…å«æ‰€æœ‰å¿…è¦æ­¥éª¤
3. åªæœ‰åœ¨ç¡®å®éœ€è¦é‡æ–°è§„åˆ’æ—¶æ‰ä½¿ç”¨ replan å·¥å…·ï¼Œä¸è¦æ»¥ç”¨
4. ä½ å¯ä»¥ä½¿ç”¨ run_command å·¥å…·æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼Œå¦‚æ–‡ä»¶æ“ä½œã€å®‰è£…åŒ…ç­‰
5. ä½¿ç”¨ run_command æ—¶è¦ç¡®ä¿å‘½ä»¤å®‰å…¨ï¼Œé¿å…ç ´åæ€§æ“ä½œ

è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹JSONæ ¼å¼è¿”å›ä½ çš„å†³ç­–:
{
  "action": "å·¥å…·åç§°",
  "input": "å·¥å…·è¾“å…¥ï¼ˆå¦‚æœéœ€è¦ï¼‰",
  "output": "è¾“å‡ºå†…å®¹ï¼ˆå¦‚æœactionæ˜¯thinkæˆ–completeï¼‰",
  "code": "ä»£ç å†…å®¹ï¼ˆå¦‚æœactionæ˜¯write_codeæˆ–debug_codeï¼‰",
  "command": "å‘½ä»¤è¡ŒæŒ‡ä»¤ï¼ˆå¦‚æœactionæ˜¯run_commandï¼‰",
  "name": "ä»£ç åç§°ï¼ˆå¦‚æœactionæ˜¯save_codeï¼‰",
  "codeId": "ä»£ç IDï¼ˆå¦‚æœactionæ˜¯run_saved_codeï¼‰",
  "newPlan": ["æ–°ä»»åŠ¡1", "æ–°ä»»åŠ¡2", "æ–°ä»»åŠ¡3"], // å¦‚æœactionæ˜¯replan
  "reasoning": "å†³ç­–ç†ç”±"
}`;
                
                const modelName = getModelName(executionModel, customExecutionModel);
                const decisionStr = await callGemini(prompt, true, modelName);
                return JSON.parse(decisionStr);
            }
            
            async function reviewTaskResult(task, output) {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„å®¡é˜…AIï¼Œè´Ÿè´£è¯„ä¼°ä»»åŠ¡æ‰§è¡Œç»“æœã€‚

åŸå§‹ä»»åŠ¡: "${task}"

æ‰§è¡Œç»“æœ:
 ${output}

è¯·è¯„ä¼°æ‰§è¡Œç»“æœæ˜¯å¦é«˜è´¨é‡åœ°å®Œæˆäº†ä»»åŠ¡ã€‚è¿”å›JSONæ ¼å¼:
{
  "passed": true/false,
  "feedback": "è¯¦ç»†åé¦ˆæ„è§",
  "score": 0-100
}`;
                
                const modelName = getModelName(reviewModel, customReviewModel);
                const reviewStr = await callGemini(prompt, true, modelName);
                return JSON.parse(reviewStr);
            }
            
            async function generateFinalReport() {
                await logStep("\næ­£åœ¨ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š...", "ğŸ“");
                
                const prompt = `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¾“å‡ºå¸ˆï¼Œè´Ÿè´£æ•´åˆæ‰€æœ‰ä¿¡æ¯å¹¶ç”Ÿæˆæœ€ç»ˆçš„ä»»åŠ¡å®ŒæˆæŠ¥å‘Šã€‚

ç”¨æˆ·åŸå§‹éœ€æ±‚: "${state.mainTask}"

ä»»åŠ¡è§„åˆ’: ${JSON.stringify(state.plan, null, 2)}

æ‰§è¡Œå†å²: ${JSON.stringify(executionHistory, null, 2)}

ä»»åŠ¡å®Œæˆç»“æœ: ${JSON.stringify(state.completedOutputs, null, 2)}

è¯·æ ¹æ®ç”¨æˆ·åŸå§‹éœ€æ±‚ï¼Œç”¨å¯å¯çˆ±çˆ±çš„è¯­æ°”ï¼Œæ•´åˆå„ä¸ªåœ°æ–¹çš„è¾“å‡ºï¼Œç»™å‡ºæœ€ç»ˆè¾“å‡ºã€‚ç®€çŸ­æœ‰åŠ›ï¼
è¯·ç›´æ¥ç”ŸæˆæŠ¥å‘Šå†…å®¹ï¼Œä¸éœ€è¦JSONæ ¼å¼ã€‚`;
                
                const modelName = getModelName(outputModel, customOutputModel);
                const report = await callGemini(prompt, false, modelName);
                
                // æ˜¾ç¤ºæœ€ç»ˆæŠ¥å‘Š
                finalReportContent.innerHTML = `
                    <div class="prose prose-invert max-w-none">
                        ${report.replace(/\n/g, '<br>')}
                    </div>
                `;
                finalReportSection.classList.remove('hidden');
                
                await logStep("æœ€ç»ˆæŠ¥å‘Šç”Ÿæˆå®Œæˆï¼", "âœ…");
            }
            
            async function finalizeTask() {
                await logStep("\næ‰€æœ‰ä»»åŠ¡å—æ‰§è¡Œå®Œæ¯•ï¼Œæ­£åœ¨æ•´åˆæœ€ç»ˆæˆæœ...", "ğŸ‰");
                const finalResult = state.completedOutputs.map(item => `<h3>${item.task}</h3>\n\n<pre class="whitespace-pre-wrap text-sm bg-gray-100 p-4 rounded-md">${item.output.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`).join('\n\n---\n\n');
                finalResultContainer.innerHTML = finalResult;
                finalResultSection.classList.remove('hidden');
                
                // ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
                await generateFinalReport();
                
                await logStep("ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼", "ğŸ†");
                setBusy(false);
            }

            // --- åç«¯APIè°ƒç”¨ ---
            async function saveCodeToBackend(name, code) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/save_code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, code })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`ä¿å­˜ä»£ç å¤±è´¥: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return { success: true, codeId: result.code_id, message: result.message };
                } catch (error) {
                    console.error('ä¿å­˜ä»£ç é”™è¯¯:', error);
                    return { success: false, error: error.message };
                }
            }
            
            async function getSavedCodesList() {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/saved_codes');
                    
                    if (!response.ok) {
                        throw new Error(`è·å–ä»£ç åˆ—è¡¨å¤±è´¥: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.codes || [];
                } catch (error) {
                    console.error('è·å–ä»£ç åˆ—è¡¨é”™è¯¯:', error);
                    // ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œå› ä¸ºåç«¯å¯èƒ½æ²¡æœ‰è¿è¡Œ
                    return [];
                }
            }
            
            async function runSavedCodeFromBackend(codeId) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/run_saved_code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ code_id: codeId })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`è¿è¡Œä¿å­˜çš„ä»£ç å¤±è´¥: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return { 
                        success: true, 
                        output: result.output, 
                        error: result.error,
                        return_code: result.return_code,
                        execution_time: result.execution_time
                    };
                } catch (error) {
                    console.error('è¿è¡Œä¿å­˜çš„ä»£ç é”™è¯¯:', error);
                    return { success: false, error: error.message };
                }
            }
            
            async function loadSavedCodes() {
                savedCodes = await getSavedCodesList();
                updateSavedCodesDisplay();
            }
            
            // --- å·¥å…·å’ŒAPIè°ƒç”¨ ---
            async function runPythonCode(code) {
                return new Promise((resolve) => {
                    const request_id = Date.now() + Math.random().toString();
                    toolResponses.set(request_id, resolve);
                    socket.emit('use_tool', { tool: 'run_code', query: code, request_id });
                });
            }
            
            async function runCommand(command) {
                return new Promise((resolve) => {
                    const request_id = Date.now() + Math.random().toString();
                    toolResponses.set(request_id, resolve);
                    socket.emit('use_tool', { tool: 'run_command', query: command, request_id });
                });
            }

            async function decomposeTask(task) {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªä»»åŠ¡è§„åˆ’AIï¼Œè´Ÿè´£å°†ç”¨æˆ·ä»»åŠ¡æ‹†åˆ†ä¸ºåˆ‡å®å¯è¡Œçš„ä»»åŠ¡å—ã€‚

ç”¨æˆ·ä»»åŠ¡: "${task}"

æ‰§è¡ŒAIæ‹¥æœ‰ä»¥ä¸‹å¼ºå¤§èƒ½åŠ›ï¼š
1. å¯ä»¥ç¼–å†™å¹¶è¿è¡ŒPythonä»£ç ï¼ˆåŒ…æ‹¬æ•°å­¦è®¡ç®—ã€æ•°æ®å¤„ç†ã€æ–‡ä»¶æ“ä½œç­‰ï¼‰
2. å¯ä»¥æ‰§è¡Œç³»ç»Ÿå‘½ä»¤ï¼ˆå¦‚lsã€dirã€pip installã€gitç­‰ï¼‰
3. å¯ä»¥ä¿å­˜å’Œé‡ç”¨ä»£ç 
4. å¯ä»¥ç›´æ¥æ€è€ƒå¹¶ç»™å‡ºç­”æ¡ˆ

è¯·å°†ä»»åŠ¡æ‹†åˆ†ä¸ºä¸€ç³»åˆ—é«˜å±‚æ¬¡çš„ã€å…·ä½“çš„ä»»åŠ¡å—ã€‚æ¯ä¸ªä»»åŠ¡å—åº”è¯¥æ˜¯ä¸€ä¸ªæ˜ç¡®çš„æ­¥éª¤ï¼Œä½†ä¸è¦è¿‡äºç»†åŒ–æ‰§è¡Œç»†èŠ‚ã€‚

é‡è¦åŸåˆ™ï¼š
1. ä»»åŠ¡å—è¦é«˜å±‚æ¬¡çš„ã€å…·ä½“çš„ï¼Œé¿å…æè¿°æ‰§è¡Œç»†èŠ‚
2. å……åˆ†åˆ©ç”¨æ‰§è¡ŒAIçš„èƒ½åŠ›ï¼Œå°†å¤æ‚çš„è®¡ç®—æˆ–æ“ä½œåˆå¹¶ä¸ºä¸€ä¸ªä»»åŠ¡å—
3. ä¿æŒ"ç®€ç•¥ä½†ä¸ç®€é™‹" - å³ç®€æ´ä½†åŒ…å«æ‰€æœ‰å¿…è¦æ­¥éª¤
4. é¿å…å°†å¯ä»¥ä¸€æ­¥å®Œæˆçš„æ“ä½œæ‹†åˆ†æˆå¤šä¸ªæ­¥éª¤

é”™è¯¯çš„ä¾‹å­ï¼ˆè¿‡äºç»†åŒ–ï¼‰ï¼š
å¯¹äº"12345213432321æ˜¯ä¸æ˜¯ç´ æ•°"ï¼Œä¸åº”è¯¥æ‹†åˆ†ä¸ºï¼š
1. è·å–å¾…æ£€æµ‹çš„æ•°å­—
2. è¿›è¡ŒåŸºæœ¬æ’é™¤
3. è®¡ç®—å¹³æ–¹æ ¹
4. è¯•é™¤æ³•æ£€æŸ¥
5. åˆ¤æ–­ç»“æœ

æ­£ç¡®çš„ä¾‹å­ï¼ˆç®€æ´é«˜æ•ˆï¼‰ï¼š
å¯¹äº"12345213432321æ˜¯ä¸æ˜¯ç´ æ•°"ï¼Œåº”è¯¥æ‹†åˆ†ä¸ºï¼š
1. ç¼–å†™ä»£ç æ£€æµ‹è¯¥æ•°å­—æ˜¯å¦ä¸ºç´ æ•°

è¯·åªè¿”å›JSONæ•°ç»„ï¼Œæ ¼å¼å¦‚ä¸‹:
[
  "ä»»åŠ¡å—1",
  "ä»»åŠ¡å—2",
  "ä»»åŠ¡å—3"
]

ä¾‹å¦‚ï¼Œå¯¹äº"åˆ†æä¸€ä¸ªCSVæ–‡ä»¶ä¸­çš„é”€å”®æ•°æ®å¹¶ç”Ÿæˆå¯è§†åŒ–æŠ¥å‘Š"ï¼Œåº”è¯¥è¿”å›:
[
  "æŸ¥æ‰¾å¹¶åŠ è½½CSVæ–‡ä»¶",
  "ä½¿ç”¨Pythonåˆ†ææ•°æ®å¹¶ç”Ÿæˆå¯è§†åŒ–å›¾è¡¨",
  "åˆ›å»ºåˆ†ææŠ¥å‘Š"
]`;
                
                const modelName = getModelName(planningModel, customPlanningModel);
                const raw = await callGemini(prompt, true, modelName);
                await logStep(`æ¨¡å‹è§„åˆ’è¿”å›: ${String(raw).slice(0,1000)}`, "ğŸ“„");

                function safeParseModelJson(text) {
                    if (typeof text !== 'string') return text;
                    const cleanedText = text.replace(/```(?:json)?/gi, '').replace(/```/g, '').trim();
                    try {
                        return JSON.parse(cleanedText);
                    } catch (e) {
                        console.error("JSON è§£æå¤±è´¥:", e, "åŸå§‹æ–‡æœ¬:", text);
                        throw new Error("æ— æ³•å°†æ¨¡å‹è¿”å›è§£æä¸º JSONã€‚è¿”å›é¢„è§ˆ: " + text.slice(0, 500));
                    }
                }
                return safeParseModelJson(raw);
            }

            async function callGemini(prompt, useJson = false, model = 'gemini-2.0-flash-exp') {
                // å®ç°APIè°ƒç”¨é€Ÿç‡é™åˆ¶
                const now = Date.now();
                const timeSinceLastCall = now - lastApiCallTime;
                const minDelay = (settings.apiRequestDelay || 6) * 1000; // è½¬æ¢ä¸ºæ¯«ç§’
                
                if (timeSinceLastCall < minDelay) {
                    const waitTime = minDelay - timeSinceLastCall;
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                lastApiCallTime = Date.now();
                apiCallCount++;
                
                const maxRetriesCount = parseInt(settings.maxRetries) || 3;
                let lastError = null;
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
                
                for (let attempt = 1; attempt <= maxRetriesCount; attempt++) {
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        if (useJson) {
                            payload.generationConfig = { responseMimeType: "application/json" };
                        }
                        
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            let errorBodyText = await response.text();
                            let errorMessage = `API è¯·æ±‚å¤±è´¥: ${response.status}.`;
                            try {
                               const errorBody = JSON.parse(errorBodyText);
                               errorMessage += ` ${errorBody.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                               
                               // æ£€æŸ¥æ˜¯å¦æ˜¯é€Ÿç‡é™åˆ¶é”™è¯¯
                               if (response.status === 429) {
                                   const retryAfter = errorBody.error?.details?.[0]?.retryAfter?.seconds || 60;
                                   errorMessage += ` è¯·åœ¨ ${retryAfter} ç§’åé‡è¯•ã€‚`;
                                   
                                   // æ˜¾ç¤ºAPIçŠ¶æ€
                                   showApiStatus(`APIé€Ÿç‡é™åˆ¶å·²è¾¾åˆ°ï¼Œè¯·åœ¨ ${retryAfter} ç§’åé‡è¯•`, 'error');
                                   
                                   // å¦‚æœæ˜¯é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…æŒ‡å®šæ—¶é—´åé‡è¯•
                                   if (attempt < maxRetriesCount) {
                                       await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                                       continue;
                                   }
                               } else if (response.status === 503) {
                                   errorMessage += ` æ¨¡å‹è¿‡è½½ï¼Œè¯·ç¨åé‡è¯•ã€‚`;
                                   showApiStatus('æ¨¡å‹è¿‡è½½ï¼Œè¯·ç¨åé‡è¯•', 'warning');
                               }
                            } catch(e) {
                               errorMessage += ` å“åº”å†…å®¹: ${errorBodyText}`;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const data = await response.json();
                        
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0]?.content?.parts?.[0]) {
                            // é‡ç½®é”™è¯¯è®¡æ•°
                            apiErrorCount = 0;
                            return data.candidates[0].content.parts[0].text;
                        }
                        
                        if (data.promptFeedback) {
                            throw new Error(`è¯·æ±‚è¢«æ¨¡å‹é˜»æ­¢ï¼ŒåŸå› : ${data.promptFeedback?.blockReason || 'æœªçŸ¥'}. è¯¦æƒ…: ${JSON.stringify(data.promptFeedback.safetyRatings)}`);
                        }

                        throw new Error("APIè¿”å›äº†æ„æ–™ä¹‹å¤–çš„ç©ºå†…å®¹ã€‚");

                    } catch (error) {
                        lastError = error;
                        apiErrorCount++;
                        console.warn(`Gemini API è°ƒç”¨å¤±è´¥ (å°è¯• ${attempt}/${maxRetriesCount}):`, error);
                        
                        // å¦‚æœè¿ç»­é”™è¯¯è¶…è¿‡5æ¬¡ï¼Œæ˜¾ç¤ºè­¦å‘Š
                        if (apiErrorCount >= 5) {
                            showApiStatus('APIè¿ç»­è°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–APIå¯†é’¥', 'error');
                        }
                        
                        if (attempt < maxRetriesCount) {
                            // æŒ‡æ•°é€€é¿é‡è¯•
                            const delay = Math.min(Math.pow(2, attempt) * 1000, 30000); // æœ€å¤§30ç§’
                            await logStep(`API è°ƒç”¨å¤±è´¥ï¼Œ${delay/1000}ç§’åé‡è¯•...`, "â±ï¸");
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                throw lastError || new Error('Gemini API è°ƒç”¨åœ¨å¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥');
            }
            
            // --- UI è¾…åŠ©å‡½æ•° ---
            function createExecutionDisplay(taskIndex, task) {
                const div = document.createElement('div');
                div.className = 'mb-6 p-4 bg-white rounded-lg shadow';
                div.id = `execution-${taskIndex}`;
                
                div.innerHTML = `
                    <h3 class="text-lg font-semibold mb-3">ä»»åŠ¡å— #${taskIndex + 1}: ${task}</h3>
                    <div class="tool-chain" id="tool-chain-${taskIndex}">
                        <div class="text-gray-500 text-sm">ç­‰å¾…æ‰§è¡Œ...</div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">æœ€ç»ˆç»“æœ:</div>
                        <div id="result-${taskIndex}" class="text-gray-500 text-sm">ç­‰å¾…å®Œæˆ...</div>
                    </div>
                `;
                
                return div;
            }
            
            function addToolChainStep(executionDiv, decision) {
                const taskIndex = executionDiv.id.split('-')[1];
                const toolChainDiv = document.getElementById(`tool-chain-${taskIndex}`);
                
                // æ¸…é™¤åˆå§‹æç¤º
                if (toolChainDiv.querySelector('.text-gray-500')) {
                    toolChainDiv.innerHTML = '';
                }
                
                const stepDiv = document.createElement('div');
                stepDiv.className = 'tool-step';
                stepDiv.id = `step-${taskIndex}-${Date.now()}`;
                
                let iconClass = '';
                let iconText = '';
                
                switch (decision.action) {
                    case 'think':
                        iconClass = 'think';
                        iconText = 'ğŸ’­';
                        break;
                    case 'write_code':
                        iconClass = 'write';
                        iconText = 'ğŸ“';
                        break;
                    case 'debug_code':
                        iconClass = 'debug';
                        iconText = 'ğŸ›';
                        break;
                    case 'run_code':
                        iconClass = 'run';
                        iconText = 'â–¶ï¸';
                        break;
                    case 'run_command':
                        iconClass = 'command';
                        iconText = 'ğŸ’»';
                        break;
                    case 'save_code':
                        iconClass = 'save';
                        iconText = 'ğŸ’¾';
                        break;
                    case 'run_saved_code':
                        iconClass = 'run';
                        iconText = 'ğŸ“‚';
                        break;
                    case 'replan':
                        iconClass = 'think';
                        iconText = 'ğŸ”„';
                        break;
                    case 'complete':
                        iconClass = 'think';
                        iconText = 'ğŸ';
                        break;
                    default:
                        iconClass = 'think';
                        iconText = 'â“';
                }
                
                let content = '';
                
                if (decision.action === 'think' || decision.action === 'complete') {
                    content = `
                        <div class="tool-name">${decision.action === 'think' ? 'æ€è€ƒ' : 'å®Œæˆ'}</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">è¾“å‡º:</div>
                            <div class="text-sm mt-1 p-2 bg-gray-100 rounded">${decision.output || ''}</div>
                        </div>
                    `;
                } else if (decision.action === 'replan') {
                    content = `
                        <div class="tool-name">é‡æ–°è§„åˆ’</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">æ–°è®¡åˆ’:</div>
                            <div class="text-sm mt-1 p-2 bg-gray-100 rounded">
                                <ol class="list-decimal list-inside">
                                    ${(decision.newPlan || []).map(item => `<li>${item}</li>`).join('')}
                                </ol>
                            </div>
                        </div>
                    `;
                } else if (decision.action === 'write_code' || decision.action === 'debug_code') {
                    content = `
                        <div class="tool-name">${decision.action === 'write_code' ? 'ç¼–å†™ä»£ç ' : 'è°ƒè¯•ä»£ç '}</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">ä»£ç :</div>
                            <div class="code-editor mt-1">${decision.code || ''}</div>
                        </div>
                    `;
                } else if (decision.action === 'run_code') {
                    content = `
                        <div class="tool-name">è¿è¡Œä»£ç </div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">è¿è¡Œç»“æœ:</div>
                            <div class="text-sm mt-1 text-gray-500">ç­‰å¾…è¿è¡Œç»“æœ...</div>
                        </div>
                    `;
                } else if (decision.action === 'run_command') {
                    content = `
                        <div class="tool-name">è¿è¡Œå‘½ä»¤</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">å‘½ä»¤:</div>
                            <div class="code-editor mt-1">${decision.command || ''}</div>
                            <div class="text-sm mt-1 text-gray-500">ç­‰å¾…æ‰§è¡Œç»“æœ...</div>
                        </div>
                    `;
                } else if (decision.action === 'save_code') {
                    content = `
                        <div class="tool-name">ä¿å­˜ä»£ç </div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">ä¿å­˜ä¸º: ${decision.name || 'æœªå‘½å'}</div>
                            <div class="text-sm mt-1 text-gray-500">ç­‰å¾…ä¿å­˜ç»“æœ...</div>
                        </div>
                    `;
                } else if (decision.action === 'run_saved_code') {
                    content = `
                        <div class="tool-name">è¿è¡Œå·²ä¿å­˜ä»£ç </div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">ä»£ç ID: ${decision.codeId || ''}</div>
                            <div class="text-sm mt-1 text-gray-500">ç­‰å¾…è¿è¡Œç»“æœ...</div>
                        </div>
                    `;
                }
                
                stepDiv.innerHTML = `
                    <div class="tool-icon ${iconClass}">${iconText}</div>
                    <div class="tool-content">${content}</div>
                `;
                
                toolChainDiv.appendChild(stepDiv);
            }
            
            function updateToolChainStep(executionDiv, stepIndex, decision) {
                const taskIndex = executionDiv.id.split('-')[1];
                const toolChainDiv = document.getElementById(`tool-chain-${taskIndex}`);
                const steps = toolChainDiv.querySelectorAll('.tool-step');
                const stepDiv = steps[stepIndex];
                
                if (!stepDiv) return;
                
                if (decision.action === 'run_code') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.runResult) {
                        if (decision.runResult.error) {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">è¿è¡Œå‡ºé”™:</div>
                                <div class="code-output mt-1">${decision.runResult.error}</div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-green-600 font-medium">è¿è¡ŒæˆåŠŸ:</div>
                                <div class="code-output mt-1">${decision.runResult.result || ''}</div>
                            `;
                        }
                    }
                } else if (decision.action === 'run_command') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.runResult) {
                        if (decision.runResult.error) {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">æ‰§è¡Œå‡ºé”™:</div>
                                <div class="code-output mt-1">${decision.runResult.error}</div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-green-600 font-medium">æ‰§è¡ŒæˆåŠŸ:</div>
                                <div class="code-output mt-1">${decision.runResult.result || ''}</div>
                            `;
                        }
                    }
                } else if (decision.action === 'save_code') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.saveResult) {
                        if (decision.saveResult.success) {
                            resultDiv.innerHTML = `
                                <div class="text-green-600 font-medium">ä¿å­˜æˆåŠŸ:</div>
                                <div class="text-sm mt-1">ä»£ç ID: ${decision.saveResult.codeId}</div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">ä¿å­˜å¤±è´¥:</div>
                                <div class="text-sm mt-1">${decision.saveResult.error}</div>
                            `;
                        }
                    }
                } else if (decision.action === 'run_saved_code') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.runResult) {
                        if (decision.runResult.success) {
                            if (decision.runResult.error) {
                                resultDiv.innerHTML = `
                                    <div class="text-red-600 font-medium">è¿è¡Œå‡ºé”™:</div>
                                    <div class="code-output mt-1">${decision.runResult.error}</div>
                                `;
                            } else {
                                resultDiv.innerHTML = `
                                    <div class="text-green-600 font-medium">è¿è¡ŒæˆåŠŸ:</div>
                                    <div class="code-output mt-1">${decision.runResult.output || ''}</div>
                                `;
                            }
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">è¿è¡Œå¤±è´¥:</div>
                                <div class="text-sm mt-1">${decision.runResult.error}</div>
                            `;
                        }
                    }
                }
            }
            
            function updateExecutionDisplay(executionDiv, status, output, feedback = '') {
                const taskIndex = executionDiv.id.split('-')[1];
                const resultDiv = document.getElementById(`result-${taskIndex}`);
                
                if (status === 'completed') {
                    resultDiv.innerHTML = `
                        <div class="text-green-600 font-medium mb-2">âœ… ä»»åŠ¡å®Œæˆ</div>
                        <div class="text-sm">${output || ''}</div>
                    `;
                } else if (status === 'failed') {
                    resultDiv.innerHTML = `
                        <div class="text-red-600 font-medium mb-2">âŒ ä»»åŠ¡å¤±è´¥</div>
                        <div class="text-sm mb-2">${output || ''}</div>
                        <div class="text-sm text-orange-600">åé¦ˆ: ${feedback || ''}</div>
                    `;
                }
            }
            
            function updateSavedCodesDisplay() {
                savedCodesContainer.innerHTML = '';
                
                if (!savedCodes || savedCodes.length === 0) {
                    savedCodesContainer.innerHTML = '<div class="text-gray-500 text-sm">æš‚æ— ä¿å­˜çš„ä»£ç </div>';
                    return;
                }
                
                for (const codeInfo of savedCodes) {
                    const codeDiv = document.createElement('div');
                    codeDiv.className = 'saved-code-item';
                    codeDiv.dataset.codeId = codeInfo.id;
                    
                    codeDiv.innerHTML = `
                        <div class="font-medium">${codeInfo.name}</div>
                        <div class="text-xs text-gray-500">${new Date(codeInfo.created_at).toLocaleString()}</div>
                        <div class="text-xs text-gray-600 mt-1">ä»£ç é•¿åº¦: ${codeInfo.code.length} å­—ç¬¦</div>
                    `;
                    
                    codeDiv.addEventListener('click', () => {
                        // é€‰ä¸­ä»£ç 
                        document.querySelectorAll('.saved-code-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        codeDiv.classList.add('selected');
                        selectedCodeId = codeInfo.id;
                    });
                    
                    savedCodesContainer.appendChild(codeDiv);
                }
                
                savedCodesSection.classList.remove('hidden');
            }
            
            function askForConfirmation(tool, query) { 
                return new Promise(resolve => { 
                    modalTool.textContent = tool; 
                    modalQuery.textContent = query; 
                    confirmationModal.classList.remove('hidden'); 
                    modalResolver = resolve; 
                }); 
            }
            
            approveBtn.addEventListener('click', () => { 
                if (modalResolver) { 
                    confirmationModal.classList.add('hidden'); 
                    modalResolver(true); 
                    modalResolver = null; 
                } 
            });
            
            rejectBtn.addEventListener('click', () => { 
                if (modalResolver) { 
                    confirmationModal.classList.add('hidden'); 
                    modalResolver(false); 
                    modalResolver = null; 
                } 
            });
            
            function initializeState() { 
                state = { 
                    apiKey: apiKeyInput.value.trim(), 
                    mainTask: mainTaskInput.value.trim(), 
                    plan: [], 
                    completedOutputs: [], 
                    isBusy: false, 
                }; 
                planSection.classList.add('hidden'); 
                executionSection.classList.add('hidden'); 
                logSection.classList.add('hidden'); 
                savedCodesSection.classList.add('hidden');
                finalResultSection.classList.add('hidden'); 
                finalReportSection.classList.add('hidden');
                planContainer.innerHTML = ''; 
                executionContainer.innerHTML = '';
                logContainer.innerHTML = ''; 
                savedCodesContainer.innerHTML = '';
                finalResultContainer.innerHTML = ''; 
                finalReportContent.innerHTML = '';
                savedCodes = {};
                selectedCodeId = null;
                executionHistory = [];
            }
            
            function validateInputs() { 
                if (!socket.connected) { 
                    alert("æœªè¿æ¥åˆ°åç«¯å·¥å…·æœåŠ¡å™¨ã€‚"); 
                    return false; 
                } 
                if (!state.apiKey) { 
                    alert("è¯·è¾“å…¥API Keyã€‚"); 
                    return false; 
                } 
                if (!state.mainTask) { 
                    alert("è¯·è¾“å…¥ä»»åŠ¡ã€‚"); 
                    return false; 
                } 
                return true; 
            }
            
            function setBusy(isBusy) { 
                state.isBusy = isBusy; 
                startButton.disabled = isBusy; 
                apiKeyInput.disabled = isBusy; 
                mainTaskInput.disabled = isBusy; 
                buttonLoader.classList.toggle('hidden', !isBusy); 
                buttonText.textContent = isBusy ? 'æ­£åœ¨è¿è¡Œ...' : 'å¼€å§‹ä»»åŠ¡'; 
            }
            
            function displayPlan() { 
                planContainer.innerHTML = ''; 
                state.plan.forEach((task, index) => { 
                    const taskDiv = document.createElement('div'); 
                    taskDiv.className = 'task-list-item p-3 bg-white border-l-4 rounded-r-md shadow-sm status-pending mb-2'; 
                    taskDiv.id = `task-item-${index}`; 
                    taskDiv.textContent = `${index + 1}. ${task}`; 
                    planContainer.appendChild(taskDiv); 
                }); 
                planSection.classList.remove('hidden'); 
            }
            
            function updateTaskStatus(taskId, status) { 
                const taskItem = document.getElementById(`task-item-${taskId}`); 
                if (taskItem) { 
                    taskItem.classList.remove('status-pending', 'status-running', 'status-completed', 'status-failed'); 
                    taskItem.classList.add(`status-${status}`); 
                } 
            }
            
            async function logStep(message, emoji = "â¡ï¸") { 
                return new Promise(resolve => { 
                    if (!logSection.classList.contains('hidden')) { 
                        logContainer.scrollTop = logContainer.scrollHeight; 
                    } else { 
                        logSection.classList.remove('hidden'); 
                    } 
                    const entry = document.createElement('div'); 
                    entry.className = 'log-entry opacity-0'; 
                    entry.innerHTML = `<span class="mr-2">${emoji}</span><span>${message.replace(/</g, "<").replace(/>/g, ">")}</span>`; 
                    logContainer.appendChild(entry); 
                    setTimeout(() => { 
                        entry.classList.remove('opacity-0'); 
                        logContainer.scrollTop = logContainer.scrollHeight; 
                        setTimeout(resolve, 50); 
                    }, 50); 
                }); 
            }
            
            async function handleFatalError(error) { 
                console.error("Agent è¿è¡Œå‡ºé”™:", error); 
                await logStep(`å‘ç”Ÿä¸¥é‡é”™è¯¯ï¼Œä»»åŠ¡ä¸­æ­¢: ${error.message}`, "âŒ"); 
                setBusy(false); 
            }

            // --- DOM äº‹ä»¶ç›‘å¬ ---
            startButton.addEventListener('click', runAgent);
            mainTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') runAgent(); });
            settingsButton.addEventListener('click', () => { settingsModal.classList.remove('hidden'); });
            closeSettingsBtn.addEventListener('click', () => { settingsModal.classList.add('hidden'); });
            saveSettingsBtn.addEventListener('click', () => { saveSettings(); settingsModal.classList.add('hidden'); });
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.add('hidden'); } });
            refreshSavedCodesBtn.addEventListener('click', loadSavedCodes);
            
            // å¤„ç†æ¨¡å‹é€‰æ‹©å˜åŒ–
            planningModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customPlanningModel.classList.remove('hidden');
                } else {
                    customPlanningModel.classList.add('hidden');
                }
            });
            
            executionModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customExecutionModel.classList.remove('hidden');
                } else {
                    customExecutionModel.classList.add('hidden');
                }
            });
            
            reviewModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customReviewModel.classList.remove('hidden');
                } else {
                    customReviewModel.classList.add('hidden');
                }
            });
            
            outputModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customOutputModel.classList.remove('hidden');
                } else {
                    customOutputModel.classList.add('hidden');
                }
            });
            
            // åˆå§‹åŒ–æ—¶åŠ è½½ä¿å­˜çš„ä»£ç 
            loadSavedCodes();
            loadSettings();
        });
    </script>
</body>
</html>