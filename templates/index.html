<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡ªä¸»ä»»åŠ¡å®Œæˆä»£ç† (å‰ç«¯APIè°ƒç”¨ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-block { border-left: 2px solid #e5e7eb; padding-left: 1rem; margin-bottom: 1rem; }
        .task-list-item { transition: all 0.3s ease; }
        .task-list-item.status-pending { border-left-color: #9ca3af; }
        .task-list-item.status-running { border-left-color: #3b82f6; background-color: #eff6ff; }
        .task-list-item.status-completed { border-left-color: #22c55e; }
        .task-list-item.status-failed { border-left-color: #ef4444; background-color: #fef2f2; }
        .log-entry { transition: opacity 0.5s ease; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #serverStatus { transition: all 0.3s ease; }
        #confirmationModal, #settingsModal { transition: opacity 0.3s ease; }
        .settings-button { position: absolute; top: 1rem; right: 1rem; z-index: 10; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- ä¸»å®¹å™¨ -->
    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8 relative">
            <button id="settingsButton" class="settings-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-300 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379-1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
            </button>
            <div class="flex justify-center items-center gap-2 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">è‡ªä¸»ä»»åŠ¡å®Œæˆä»£ç†</h1>
                <span id="serverStatus" class="h-4 w-4 rounded-full bg-red-500" title="æœªè¿æ¥åˆ°å·¥å…·æœåŠ¡å™¨"></span>
            </div>
            <p class="mt-2 text-gray-600">Gemini æ¨¡å‹é©±åŠ¨ï¼Œæ”¯æŒå¹¶è¡Œä»»åŠ¡å¤„ç†ä¸äººå·¥ç¡®è®¤ã€‚</p>
        </header>
        
        <div class="mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
            <p class="font-bold"âš ï¸ å®‰å…¨è­¦å‘Š</p>
            <p>æ‚¨çš„ Gemini API Key å°†ç›´æ¥åœ¨æµè§ˆå™¨ä¸­ç”¨äºè°ƒç”¨APIã€‚è¯·å‹¿åœ¨å…¬å…±ç½‘ç«™æˆ–ä¸å—ä¿¡ä»»çš„ç¯å¢ƒä¸­ä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå› ä¸ºå®ƒä¼šæš´éœ²æ‚¨çš„å¯†é’¥ã€‚æ­¤æ–¹æ³•ä»…é€‚ç”¨äºæœ¬åœ°å¼€å‘æˆ–ä¸ªäººé¡¹ç›®ã€‚</p>
            <input type="password" id="apiKeyInput" placeholder="åœ¨æ­¤è¾“å…¥ä½ çš„ Gemini API Key" class="mt-2 w-full p-2 border border-red-300 rounded-md focus:ring-2 focus:ring-red-500 focus:outline-none">
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="mainTaskInput" placeholder="ä¾‹å¦‚ï¼šå®‰è£…pandasåº“ï¼Œç„¶åç”¨å®ƒåˆ†æä¸€æ®µæ•°æ®" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="startButton" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="buttonText">å¼€å§‹ä»»åŠ¡</span>
                    <div id="buttonLoader" class="loader ml-2 hidden"></div>
                </button>
            </div>
        </div>
        
        <div id="results" class="space-y-8">
            <section id="planSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">ä»»åŠ¡è®¡åˆ’</h2>
                <div id="planContainer"></div>
            </section>
            <section id="logSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">æ‰§è¡Œæ—¥å¿—</h2>
                <div id="logContainer" class="p-4 bg-gray-900 text-white rounded-md font-mono text-sm max-h-96 overflow-y-auto space-y-2"></div>
            </section>
            <section id="finalResultSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">æœ€ç»ˆæˆæœ</h2>
                <div id="finalResultContainer" class="p-6 bg-white rounded-lg shadow prose max-w-none"></div>
            </section>
        </div>
    </div>
    
    <!-- ç¡®è®¤æ¨¡æ€æ¡† -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"><svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg></div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">éœ€è¦ä½ çš„ç¡®è®¤</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Agent æè®®æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p>
                    <div id="modalContent" class="mt-2 text-left bg-gray-100 p-3 rounded-md">
                        <p><strong>å·¥å…·:</strong> <code id="modalTool" class="text-red-500 font-semibold"></code></p>
                        <p><strong>è¾“å…¥:</strong></p>
                        <pre id="modalQuery" class="whitespace-pre-wrap text-sm bg-gray-800 text-white p-2 rounded mt-1 max-h-40 overflow-y-auto"></pre>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="approveBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">æ‰¹å‡†</button>
                    <button id="rejectBtn" class="mt-3 px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">æ‹’ç»</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">è®¾ç½®</h3>
                    <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-base font-medium text-gray-900">è‡ªåŠ¨æ‰¹å‡†</h4>
                            <p class="text-sm text-gray-500">å¯ç”¨åå°†è‡ªåŠ¨æ‰¹å‡†æ‰€æœ‰å·¥å…·ä½¿ç”¨è¯·æ±‚</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoApproveToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-base font-medium text-gray-900">æ¨¡å‹é€‰æ‹©</h4>
                        <div>
                            <label for="planningModel" class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡è§„åˆ’æ¨¡å‹</label>
                            <select id="planningModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨è)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                            </select>
                        </div>
                        <div>
                            <label for="executionModel" class="block text-sm font-medium text-gray-700 mb-1">ä»»åŠ¡æ‰§è¡Œæ¨¡å‹</label>
                            <select id="executionModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨è)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                            </select>
                        </div>
                        <div>
                            <label for="evaluationModel" class="block text-sm font-medium text-gray-700 mb-1">ç»“æœè¯„ä¼°æ¨¡å‹</label>
                            <select id="evaluationModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (æ¨è)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="saveSettingsBtn" class="w-full px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- [FIX] Wrap all code in DOMContentLoaded listener to ensure libraries are loaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM å…ƒç´  ---
            const apiKeyInput = document.getElementById('apiKeyInput');
            const mainTaskInput = document.getElementById('mainTaskInput');
            const startButton = document.getElementById('startButton');
            const buttonText = document.getElementById('buttonText');
            const buttonLoader = document.getElementById('buttonLoader');
            const serverStatus = document.getElementById('serverStatus');
            const planSection = document.getElementById('planSection');
            const planContainer = document.getElementById('planContainer');
            const logSection = document.getElementById('logSection');
            const logContainer = document.getElementById('logContainer');
            const finalResultSection = document.getElementById('finalResultSection');
            const finalResultContainer = document.getElementById('finalResultContainer');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalTool = document.getElementById('modalTool');
            const modalQuery = document.getElementById('modalQuery');
            const approveBtn = document.getElementById('approveBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const settingsButton = document.getElementById('settingsButton');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const autoApproveToggle = document.getElementById('autoApproveToggle');
            const planningModel = document.getElementById('planningModel');
            const executionModel = document.getElementById('executionModel');
            const evaluationModel = document.getElementById('evaluationModel');
            
            // --- çŠ¶æ€ç®¡ç† ---
            let state = {};
            const toolResponses = new Map();
            let modalResolver = null;
            
            // --- é»˜è®¤æ¨¡å‹ç»„è®¾ä¸º gemini-2.5 ç³»åˆ— ---
            let settings = {
                autoApprove: false,
                planningModel: 'gemini-2.5-flash',
                executionModel: 'gemini-2.5-flash',
                evaluationModel: 'gemini-2.5-flash'
            };
            
            function loadSettings() {
                const savedSettings = localStorage.getItem('agentSettings');
                if (savedSettings) {
                    try {
                        settings = JSON.parse(savedSettings);
                        autoApproveToggle.checked = settings.autoApprove;
                        planningModel.value = settings.planningModel;
                        executionModel.value = settings.executionModel;
                        evaluationModel.value = settings.evaluationModel;
                    } catch (e) { console.error('åŠ è½½è®¾ç½®å¤±è´¥:', e); }
                }
            }
            
            function saveSettings() {
                settings.autoApprove = autoApproveToggle.checked;
                settings.planningModel = planningModel.value;
                settings.executionModel = executionModel.value;
                settings.evaluationModel = evaluationModel.value;
                localStorage.setItem('agentSettings', JSON.stringify(settings));
            }
            
            // --- WebSocket è¿æ¥ (ä»…ç”¨äºå·¥å…·æœåŠ¡å™¨) ---
            const socket = io("http://127.0.0.1:5000");
            socket.on('connect', () => {
                serverStatus.classList.remove('bg-red-500');
                serverStatus.classList.add('bg-green-500');
                serverStatus.title = "å·²è¿æ¥åˆ°å·¥å…·æœåŠ¡å™¨";
            });
            socket.on('disconnect', () => {
                serverStatus.classList.remove('bg-green-500');
                serverStatus.classList.add('bg-red-500');
                serverStatus.title = "æœªè¿æ¥åˆ°å·¥å…·æœåŠ¡å™¨";
            });
            socket.on('tool_result', (data) => {
                const resolver = toolResponses.get(data.request_id);
                if (resolver) {
                    resolver(data);
                    toolResponses.delete(data.request_id);
                }
            });
            
            // --- æ ¸å¿ƒ Agent é€»è¾‘ ---
            async function runAgent() {
                if (state.isBusy) return;
                initializeState();
                if (!validateInputs()) return;
                setBusy(true);
                try {
                    await logStep("1. å¼€å§‹åˆ†æä»»åŠ¡ä¾èµ–å¹¶åˆ¶å®šæ‰§è¡Œè®¡åˆ’...", "ğŸ§ ");
                    const plan = await decomposeTask(state.mainTask);
                    if (!Array.isArray(plan) || plan.length === 0) {
                        await logStep("è§£æåˆ°çš„è®¡åˆ’ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„ï¼Œç»ˆæ­¢æ‰§è¡Œã€‚", "âŒ");
                        throw new Error("è§£æåˆ°çš„è®¡åˆ’ä¸ºç©ºæˆ–ä¸æ˜¯æ•°ç»„ã€‚æ£€æŸ¥æ¨¡å‹è¿”å›åŸæ–‡ä»¥å®šä½é—®é¢˜ã€‚");
                    }
                    state.plan = plan;
                    displayPlan();
                    await logStep(`   è®¡åˆ’åˆ¶å®šå®Œæ¯•ï¼Œå…± ${plan.length} ä¸ªä»»åŠ¡å—ã€‚`, "âœ…");
                    
                    for (let blockIndex = 0; blockIndex < state.plan.length; blockIndex++) {
                        const block = state.plan[blockIndex];
                        if (block.type === 'sequential') {
                            await logStep(`\nå¼€å§‹æ‰§è¡Œé¡ºåºä»»åŠ¡å— #${blockIndex + 1}`, "â¡ï¸");
                            for (let taskIndex = 0; taskIndex < block.tasks.length; taskIndex++) {
                                const task = block.tasks[taskIndex];
                                await executeAndEvaluate(task, blockIndex, taskIndex);
                            }
                        } else if (block.type === 'parallel') {
                            await logStep(`\nå¼€å§‹æ‰§è¡Œå¹¶è¡Œä»»åŠ¡å— #${blockIndex + 1}`, "âš¡");
                            const promises = block.tasks.map((task, taskIndex) => 
                                executeAndEvaluate(task, blockIndex, taskIndex)
                            );
                            await Promise.all(promises);
                            await logStep(`å¹¶è¡Œä»»åŠ¡å— #${blockIndex + 1} å…¨éƒ¨å®Œæˆ`, "âœ”ï¸");
                        } else {
                            if (Array.isArray(block.tasks)) {
                                await logStep(`\nå¼€å§‹æ‰§è¡Œæœªå£°æ˜ç±»å‹çš„ä»»åŠ¡å— #${blockIndex + 1}ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼‰`, "â¡ï¸");
                                 for (let taskIndex = 0; taskIndex < block.tasks.length; taskIndex++) {
                                    const task = block.tasks[taskIndex];
                                    await executeAndEvaluate(task, blockIndex, taskIndex);
                                }
                            } else {
                                await logStep(`æœªè¯†åˆ«çš„ä»»åŠ¡å—ç±»å‹æˆ–ç»“æ„: ${JSON.stringify(block).slice(0,500)}`, "âš ï¸");
                            }
                        }
                    }
                    await finalizeTask();
                } catch (error) {
                    await handleFatalError(error);
                }
            }
            
            async function executeAndEvaluate(subTask, blockIndex, taskIndex) {
                const taskId = `${blockIndex}-${taskIndex}`;
                updateTaskStatus(taskId, 'running');
                await logStep(`  [ä»»åŠ¡ ${taskId}] å¼€å§‹æ‰§è¡Œ: "${subTask}"`, "ğŸš€");
                
                const maxRetries = 3; 
                let lastOutput = '';
                let lastFeedback = '';
                for (let retryCount = 0; retryCount <= maxRetries; retryCount++) {
                    if (retryCount > 0) {
                        await logStep(`  [ä»»åŠ¡ ${taskId}] ç¬¬ ${retryCount} æ¬¡å°è¯•ä¿®æ­£...`, "ğŸ› ï¸");
                    }
                    try {
                        // æ­¥éª¤ A: å†³ç­–
                        let decision;
                        const availableTools = "run_command, run_code, write_code, time, replan_remaining_steps";
                        const toolDescriptions = `
- run_command: æ‰§è¡Œç»ˆç«¯å‘½ä»¤ (ä¾‹å¦‚ 'pip install pandas')ã€‚
- run_code: æ‰§è¡Œä¸€æ®µPythonä»£ç å¹¶è¿”å›è¾“å‡ºã€‚
- write_code: ç¼–å†™ä¸€æ®µPythonä»£ç ï¼Œå®ƒæœ¬èº«ä¸æ‰§è¡Œã€‚
- time: è·å–å½“å‰æ—¶é—´ã€‚
- replan_remaining_steps: å½“ä½ è®¤ä¸ºä¸»è¦ç›®æ ‡å·²è¾¾æˆï¼Œä½†è®¡åˆ’ä¸­è¿˜æœ‰å¤šä½™æ­¥éª¤æ—¶è°ƒç”¨ã€‚åœ¨ query ä¸­è¯´æ˜é‡æ–°è§„åˆ’çš„ç†ç”±ã€‚
`;

                        if (retryCount === 0) {
                            await logStep(`  [ä»»åŠ¡ ${taskId}] æ­£åœ¨å†³ç­–æ‰§è¡ŒåŠ¨ä½œ...`, "ğŸ¤”");
                            const decisionPrompt = `ä½ æ˜¯ä¸€ä¸ªå†³ç­–AIã€‚æ ¹æ®ä¸‹é¢çš„ä»»åŠ¡æè¿°å’Œå¯ç”¨å·¥å…·ï¼Œåˆ¤æ–­éœ€è¦æ‰§è¡Œä»€ä¹ˆåŠ¨ä½œã€‚\nå¯ç”¨å·¥å…·:\n${toolDescriptions}\nå½“å‰ä»»åŠ¡: "${subTask}"\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ä½ çš„å†³ç­–:\n{"tool": "tool_name", "query": "input_for_the_tool"}`;
                            const decisionStr = await callGemini(decisionPrompt, true, settings.executionModel);
                            decision = JSON.parse(decisionStr);
                        } else {
                            await logStep(`  [ä»»åŠ¡ ${taskId}] æ ¹æ®åé¦ˆåˆ¶å®šä¿®æ­£è®¡åˆ’...`, "ğŸ§ ");
                            const revisionPrompt = `ä¸€ä¸ªå­ä»»åŠ¡æ‰§è¡Œå¤±è´¥äº†ã€‚\nåŸå§‹å­ä»»åŠ¡: "${subTask}"\nä¸Šæ¬¡çš„äº§å‡º(æˆ–é”™è¯¯): "${lastOutput}"\nå¤±è´¥çš„è¯„ä¼°åé¦ˆ: "${lastFeedback}"\nè¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œé‡æ–°ä¸ºè¿™ä¸ªåŸå§‹å­ä»»åŠ¡åˆ¶å®šä¸€ä¸ªä¿®æ­£åçš„æ‰§è¡ŒåŠ¨ä½œã€‚\nå¯ç”¨å·¥å…·:\n${toolDescriptions}\nè¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¿”å›ä½ çš„å†³ç­–:\n{"tool": "tool_name", "query": "input_for_the_tool_or_revised_answer"}`;
                            const decisionStr = await callGemini(revisionPrompt, true, settings.executionModel);
                            decision = JSON.parse(decisionStr);
                        }
                        
                        // --- [æ ¸å¿ƒä¿®æ”¹] æ­¥éª¤ B: æ‰§è¡Œä¸è§£è¯» ---
                        let finalOutputForEvaluation = ''; // ç”¨äºæœ€ç»ˆè¯„ä¼°çš„å†…å®¹

                        if (decision.tool && decision.tool !== 'llm') {
                            const userApproved = settings.autoApprove || await askForConfirmation(decision.tool, decision.query);
                            if (!userApproved) {
                                lastFeedback = "ç”¨æˆ·æ‹’ç»äº†æè®®çš„æ“ä½œã€‚";
                                lastOutput = `è¢«æ‹’ç»çš„æ“ä½œ: ${decision.tool} - ${decision.query}`;
                                await logStep(`  [ä»»åŠ¡ ${taskId}] ç”¨æˆ·æ‹’ç»äº†æ“ä½œã€‚`, "ğŸ™…");
                                continue; 
                            }
                            await logStep(`  [ä»»åŠ¡ ${taskId}] ç”¨æˆ·å·²æ‰¹å‡†ã€‚æ‰§è¡Œå·¥å…· [${decision.tool}]...`, "ğŸ‘");
                            
                            if (decision.tool === 'replan_remaining_steps') {
                                await logStep(`  [ä»»åŠ¡ ${taskId}] å†³ç­–: é‡æ–°è§„åˆ’å‰©ä½™æ­¥éª¤... ç†ç”±: ${decision.query}`, "ğŸ”„");
                                const replanContext = `åŸå§‹æ€»ä»»åŠ¡: "${state.mainTask}"\n---\nå·²å®Œæˆçš„ä»»åŠ¡å’Œäº§å‡ºæ‘˜è¦:\n${state.completedOutputs.map(item => `- ä»»åŠ¡: ${item.task}\n  äº§å‡º(å‰200å­—ç¬¦): ${item.output.slice(0, 200)}...`).join('\n')}\n---\né‡æ–°è§„åˆ’çš„ç†ç”±: ${decision.query}\n---\nè¯·åŸºäºä»¥ä¸Šä¿¡æ¯ï¼Œä¸ºâ€œåŸå§‹æ€»ä»»åŠ¡â€ç”Ÿæˆä¸€ä¸ªå…¨æ–°çš„ã€æ›´ç®€æ´çš„å‰©ä½™ä»»åŠ¡è®¡åˆ’ã€‚å¦‚æœæ‰€æœ‰ç›®æ ‡éƒ½å·²è¾¾æˆï¼Œè¯·è¿”å›ä¸€ä¸ªç©ºæ•°ç»„ []ã€‚`;
                                const newPlan = await decomposeTask(replanContext);
                                await logStep(`  [ä»»åŠ¡ ${taskId}] å·²ç”Ÿæˆæ–°è®¡åˆ’ï¼Œå°†æ›¿æ¢æ‰€æœ‰æœªå¼€å§‹çš„ä»»åŠ¡ã€‚`, "âœ¨");
                                state.plan[blockIndex].tasks.splice(taskIndex + 1);
                                state.plan.splice(blockIndex + 1);
                                state.plan.push(...newPlan);
                                displayPlan();
                                finalOutputForEvaluation = "æˆåŠŸé‡æ–°è§„åˆ’äº†å‰©ä½™æ­¥éª¤ã€‚";

                            } else if (decision.tool === 'write_code') {
                                const codeGenPrompt = `è¯·åªç¼–å†™ä¸€æ®µPythonä»£ç æ¥å®ç°ä»¥ä¸‹åŠŸèƒ½ï¼Œä¸è¦åŒ…å«ä»»ä½•è§£é‡Šæˆ–markdownæ ‡è®°:\n\n${decision.query}`;
                                finalOutputForEvaluation = await callGemini(codeGenPrompt, false, settings.executionModel);
                                await logStep(`  [ä»»åŠ¡ ${taskId}] ä»£ç å·²ç”Ÿæˆã€‚`, "ğŸ“");
                            
                            } else {
                                 // å¯¹äº run_code, run_command ç­‰è¿”å›ä¿¡æ¯çš„å·¥å…·
                                 const toolResult = await useTool(decision.tool, decision.query);
                                 const toolOutput = toolResult.is_error ? `[å·¥å…·æ‰§è¡Œå¤±è´¥]: ${toolResult.result}` : toolResult.result;
                                 await logStep(`  [ä»»åŠ¡ ${taskId}] å·¥å…·è¿”å›:\n<pre class="whitespace-pre-wrap text-xs bg-gray-800 text-white p-2 rounded mt-1">${toolOutput}</pre>`, "ğŸ“¦");
                                 
                                 // **æ–°å¢çš„è§£è¯»æ­¥éª¤**
                                 await logStep(`  [ä»»åŠ¡ ${taskId}] å·²è·å–å·¥å…·è¾“å‡ºï¼Œæ­£åœ¨è§£è¯»å¹¶ç”Ÿæˆæœ€ç»ˆç»“è®º...`, "ğŸ’¡");
                                 const postToolPrompt = `å¯¹äºä»»åŠ¡â€œ${subTask}â€ï¼Œæˆ‘åˆšåˆšè°ƒç”¨äº†å·¥å…·â€œ${decision.tool}â€ï¼Œå®ƒè¿”å›äº†ä»¥ä¸‹å†…å®¹ï¼š\n\n--- å·¥å…·è¾“å‡º ---\n${toolOutput}\n---\n\nç°åœ¨ï¼Œè¯·åŸºäºè¿™ä¸ªå·¥å…·è¾“å‡ºï¼Œç”Ÿæˆå®Œæˆè¯¥ä»»åŠ¡æ‰€éœ€çš„æœ€ç»ˆç­”æ¡ˆã€ä»£ç æˆ–ç»“è®ºã€‚åªè¾“å‡ºæœ€ç»ˆç»“æœï¼Œä¸è¦è§£é‡Šã€‚`;
                                 finalOutputForEvaluation = await callGemini(postToolPrompt, false, settings.executionModel);
                                 await logStep(`  [ä»»åŠ¡ ${taskId}] å·²ç”Ÿæˆå¯¹å·¥å…·è¾“å‡ºçš„è§£è¯»ã€‚`, "âœ…");
                            }
                        } else {
                            // å¦‚æœAIå†³ç­–ä¸ä½¿ç”¨å·¥å…·ï¼Œåˆ™ç›´æ¥ç”Ÿæˆæ–‡æœ¬
                            const query = decision.query || subTask;
                            await logStep(`  [ä»»åŠ¡ ${taskId}] å†³ç­–: æ— éœ€å·¥å…·ï¼Œç”±LLMç”Ÿæˆ...`, "âœï¸");
                            const context = `åŸå§‹ç”¨æˆ·éœ€æ±‚: "${state.mainTask}"\n\n--- å·²å®Œæˆçš„å†å²è®°å½• ---\n` + 
                                            state.completedOutputs.map(item => `[ä»»åŠ¡: ${item.task}]\n[äº§å‡º: ${item.output}]`).join('\n\n');
                            const executionPrompt = `åŸºäºä»¥ä¸‹å…¨å±€ä¿¡æ¯ï¼Œè¯·å®Œæˆå½“å‰å…·ä½“ä»»åŠ¡ã€‚\n\n${context}\n\n--- å½“å‰å…·ä½“ä»»åŠ¡ ---\n"${query}"`;
                            finalOutputForEvaluation = await callGemini(executionPrompt, false, settings.executionModel);
                        }
                        
                        lastOutput = finalOutputForEvaluation;

                        // æ­¥éª¤ C: è¯„ä¼°æœ€ç»ˆäº§å‡º
                        await logStep(`  [ä»»åŠ¡ ${taskId}] å†…å®¹å·²ç”Ÿæˆï¼Œå¼€å§‹è¯„ä¼°æœ€ç»ˆäº§å‡º...`, "ğŸ§");
                        const evaluationPrompt = `ä½ æ˜¯ä¸€ä¸ªä¸¥æ ¼çš„è´¨é‡è¯„ä¼°AIã€‚è¯·è¯„ä¼°ä»¥ä¸‹äº§å‡ºæ˜¯å¦é«˜è´¨é‡åœ°å®Œæˆäº†æŒ‡å®šä»»åŠ¡ã€‚ä½ éœ€è¦è¿”å›ä¸€ä¸ª JSON å¯¹è±¡ï¼ŒåŒ…å« "completed" (å¸ƒå°”å€¼) å’Œ "feedback" (å­—ç¬¦ä¸²) ä¸¤ä¸ªå­—æ®µã€‚\næŒ‡å®šçš„ä»»åŠ¡: "${subTask}"\näº§å‡ºå†…å®¹:\n---\n${finalOutputForEvaluation}\n---`;
                        const evaluationResultStr = await callGemini(evaluationPrompt, true, settings.evaluationModel);
                        const evaluationResult = JSON.parse(evaluationResultStr);

                        if (evaluationResult.completed) {
                            await logStep(`  [ä»»åŠ¡ ${taskId}] è¯„ä¼°ç»“æœ: åˆæ ¼ã€‚`, "âœ…");
                            state.completedOutputs.push({ task: subTask, output: finalOutputForEvaluation });
                            updateTaskStatus(taskId, 'completed');
                            return; 
                        } else {
                            lastFeedback = evaluationResult.feedback;
                            await logStep(`  [ä»»åŠ¡ ${taskId}] è¯„ä¼°ç»“æœ: ä¸åˆæ ¼ã€‚åé¦ˆ: ${lastFeedback}`, "ğŸ‘");
                        }
                    } catch (error) {
                        console.error(`ä»»åŠ¡ ${taskId} æ‰§è¡Œé”™è¯¯:`, error);
                        const errorMessage = error.message || 'æœªçŸ¥é”™è¯¯';
                        await logStep(`  [ä»»åŠ¡ ${taskId}] æ‰§è¡Œé”™è¯¯: ${errorMessage}`, "âŒ");
                        lastFeedback = `æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸: ${errorMessage}`;
                        lastOutput = `[å¼‚å¸¸] ${errorMessage}`;
                        if (retryCount >= maxRetries) {
                            updateTaskStatus(taskId, 'failed');
                            throw error;
                        }
                    }
                }
                updateTaskStatus(taskId, 'failed');
                throw new Error(`ä»»åŠ¡ "${subTask}" åœ¨ ${maxRetries} æ¬¡é‡è¯•åä»ç„¶å¤±è´¥ã€‚`);
            }
            
            async function finalizeTask() {
                await logStep("\næ‰€æœ‰ä»»åŠ¡å—æ‰§è¡Œå®Œæ¯•ï¼Œæ­£åœ¨æ•´åˆæœ€ç»ˆæˆæœ...", "ğŸ‰");
                const finalResult = state.completedOutputs.map(item => `<h2>${item.task}</h2>\n\n<pre class="whitespace-pre-wrap text-sm bg-gray-100 p-4 rounded-md">${item.output.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`).join('\n\n---\n\n');
                finalResultContainer.innerHTML = finalResult;
                finalResultSection.classList.remove('hidden');
                await logStep("ä»»åŠ¡å…¨éƒ¨å®Œæˆï¼", "ğŸ†");
                setBusy(false);
            }

            // --- å·¥å…·å’ŒAPIè°ƒç”¨ ---
            function useTool(tool, query) {
                return new Promise((resolve) => {
                    const request_id = Date.now() + Math.random().toString();
                    toolResponses.set(request_id, resolve);
                    socket.emit('use_tool', { tool, query, request_id });
                });
            }

            async function decomposeTask(task) {
                const prompt = `ä½ æ˜¯ä¸€ä¸ªé¡¶çº§çš„é¡¹ç›®è§„åˆ’AIã€‚è¯·æŠŠä¸‹é¢çš„â€œä»»åŠ¡æˆ–æƒ…å¢ƒâ€åˆ†è§£ä¸ºä¸€ä¸ªJSONæ•°ç»„ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯ä¸€ä¸ªä»»åŠ¡å—ã€‚ä»»åŠ¡å—åŒ…å« "type" ('sequential' æˆ– 'parallel') å’Œ "tasks" (ä¸€ä¸ªå­—ç¬¦ä¸²ä»»åŠ¡åˆ—è¡¨)ã€‚
æƒ…å¢ƒ: ${task}
è¯·åªè¿”å›çº¯ JSONï¼ˆä¸è¦é¢å¤–è§£é‡Šæˆ–ä»£ç å—ï¼‰ã€‚ä¾‹å¦‚: [{"type":"sequential","tasks":["æ­¥éª¤1","æ­¥éª¤2"]}]`;
                const raw = await callGemini(prompt, true, settings.planningModel);
                await logStep(`æ¨¡å‹è§„åˆ’è¿”å›: ${String(raw).slice(0,1000)}`, "ğŸ“„");

                function safeParseModelJson(text) {
                    if (typeof text !== 'string') return text;
                    const cleanedText = text.replace(/```(?:json)?/gi, '').replace(/```/g, '').trim();
                    try {
                        return JSON.parse(cleanedText);
                    } catch (e) {
                        console.error("JSON è§£æå¤±è´¥:", e, "åŸå§‹æ–‡æœ¬:", text);
                        throw new Error("æ— æ³•å°†æ¨¡å‹è¿”å›è§£æä¸º JSONã€‚è¿”å›é¢„è§ˆ: " + text.slice(0, 500));
                    }
                }
                return safeParseModelJson(raw);
            }

            async function callGemini(prompt, useJson = false, model = 'gemini-2.5-flash') {
                const maxRetries = 3;
                let lastError = null;
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
                
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        if (useJson) {
                            payload.generationConfig = { responseMimeType: "application/json" };
                        }
                        
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            let errorBodyText = await response.text();
                            let errorMessage = `API è¯·æ±‚å¤±è´¥: ${response.status}.`;
                            try {
                               const errorBody = JSON.parse(errorBodyText);
                               errorMessage += ` ${errorBody.error?.message || 'æœªçŸ¥é”™è¯¯'}`;
                            } catch(e) {
                               errorMessage += ` å“åº”å†…å®¹: ${errorBodyText}`;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const data = await response.json();
                        
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0]?.content?.parts?.[0]) {
                            return data.candidates[0].content.parts[0].text;
                        }
                        
                        if (data.promptFeedback) {
                            throw new Error(`è¯·æ±‚è¢«æ¨¡å‹é˜»æ­¢ï¼ŒåŸå› : ${data.promptFeedback?.blockReason || 'æœªçŸ¥'}. è¯¦æƒ…: ${JSON.stringify(data.promptFeedback.safetyRatings)}`);
                        }

                        throw new Error("APIè¿”å›äº†æ„æ–™ä¹‹å¤–çš„ç©ºå†…å®¹ã€‚");

                    } catch (error) {
                        lastError = error;
                        console.warn(`Gemini API è°ƒç”¨å¤±è´¥ (å°è¯• ${attempt}/${maxRetries}):`, error);
                        
                        if (attempt < maxRetries) {
                            const delay = Math.pow(2, attempt) * 1000;
                            await logStep(`API è°ƒç”¨å¤±è´¥ï¼Œ${delay/1000}ç§’åé‡è¯•...`, "â±ï¸");
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                throw lastError || new Error('Gemini API è°ƒç”¨åœ¨å¤šæ¬¡é‡è¯•åä»ç„¶å¤±è´¥');
            }
            
            // --- UI å’ŒçŠ¶æ€ç®¡ç†è¾…åŠ©å‡½æ•° ---
            function askForConfirmation(tool, query) { return new Promise(resolve => { modalTool.textContent = tool; modalQuery.textContent = query; confirmationModal.classList.remove('hidden'); modalResolver = resolve; }); }
            approveBtn.addEventListener('click', () => { if (modalResolver) { confirmationModal.classList.add('hidden'); modalResolver(true); modalResolver = null; } });
            rejectBtn.addEventListener('click', () => { if (modalResolver) { confirmationModal.classList.add('hidden'); modalResolver(false); modalResolver = null; } });
            function initializeState() { state = { apiKey: apiKeyInput.value.trim(), mainTask: mainTaskInput.value.trim(), plan: [], completedOutputs: [], isBusy: false, }; planSection.classList.add('hidden'); logSection.classList.add('hidden'); finalResultSection.classList.add('hidden'); planContainer.innerHTML = ''; logContainer.innerHTML = ''; finalResultContainer.innerHTML = ''; }
            function validateInputs() { if (!socket.connected) { alert("æœªè¿æ¥åˆ°åç«¯å·¥å…·æœåŠ¡å™¨ã€‚"); return false; } if (!state.apiKey) { alert("è¯·è¾“å…¥API Keyã€‚"); return false; } if (!state.mainTask) { alert("è¯·è¾“å…¥ä»»åŠ¡ã€‚"); return false; } return true; }
            function setBusy(isBusy) { state.isBusy = isBusy; startButton.disabled = isBusy; apiKeyInput.disabled = isBusy; mainTaskInput.disabled = isBusy; buttonLoader.classList.toggle('hidden', !isBusy); buttonText.textContent = isBusy ? 'æ­£åœ¨è¿è¡Œ...' : 'å¼€å§‹ä»»åŠ¡'; }
            function displayPlan() { planContainer.innerHTML = ''; state.plan.forEach((block, blockIndex) => { const blockDiv = document.createElement('div'); blockDiv.className = 'task-block'; const blockTitle = document.createElement('h3'); blockTitle.className = 'font-semibold mb-2 text-gray-700'; blockTitle.textContent = `ä»»åŠ¡å— #${blockIndex + 1} (${block.type === 'parallel' ? 'å¹¶è¡Œ' : 'é¡ºåº'})`; blockDiv.appendChild(blockTitle); const ul = document.createElement('ul'); ul.className = 'space-y-2'; const tasks = Array.isArray(block.tasks) ? block.tasks : []; tasks.forEach((task, taskIndex) => { const li = document.createElement('li'); li.id = `task-item-${blockIndex}-${taskIndex}`; li.className = 'task-list-item p-3 bg-white border-l-4 rounded-r-md shadow-sm status-pending'; if (typeof task === 'object' && task !== null) { li.textContent = task.description || task.task || JSON.stringify(task); } else { li.textContent = task; } ul.appendChild(li); }); blockDiv.appendChild(ul); planContainer.appendChild(blockDiv); }); planSection.classList.remove('hidden'); }
            function updateTaskStatus(taskId, status) { const taskItem = document.getElementById(`task-item-${taskId}`); if (taskItem) { taskItem.classList.remove('status-pending', 'status-running', 'status-completed', 'status-failed'); taskItem.classList.add(`status-${status}`); } }
            async function logStep(message, emoji = "â¡ï¸") { return new Promise(resolve => { if (!logSection.classList.contains('hidden')) { logContainer.scrollTop = logContainer.scrollHeight; } else { logSection.classList.remove('hidden'); } const entry = document.createElement('div'); entry.className = 'log-entry opacity-0'; entry.innerHTML = `<span class="mr-2">${emoji}</span><span>${message.replace(/</g, "<").replace(/>/g, ">")}</span>`; logContainer.appendChild(entry); setTimeout(() => { entry.classList.remove('opacity-0'); logContainer.scrollTop = logContainer.scrollHeight; setTimeout(resolve, 50); }, 50); }); }
            async function handleFatalError(error, taskIndex = -1) { console.error("Agent è¿è¡Œå‡ºé”™:", error); await logStep(`å‘ç”Ÿä¸¥é‡é”™è¯¯ï¼Œä»»åŠ¡ä¸­æ­¢: ${error.message}`, "âŒ"); setBusy(false); }

            // --- DOM äº‹ä»¶ç›‘å¬ ---
            startButton.addEventListener('click', runAgent);
            mainTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') runAgent(); });
            settingsButton.addEventListener('click', () => { settingsModal.classList.remove('hidden'); });
            closeSettingsBtn.addEventListener('click', () => { settingsModal.classList.add('hidden'); });
            saveSettingsBtn.addEventListener('click', () => { saveSettings(); settingsModal.classList.add('hidden'); });
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.add('hidden'); } });
            
            loadSettings();
        });
    </script>
</body>
</html>
