<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自主任务完成代理 (重构版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-block { border-left: 2px solid #e5e7eb; padding-left: 1rem; margin-bottom: 1rem; }
        .task-list-item { transition: all 0.3s ease; }
        .task-list-item.status-pending { border-left-color: #9ca3af; }
        .task-list-item.status-running { border-left-color: #3b82f6; background-color: #eff6ff; }
        .task-list-item.status-completed { border-left-color: #22c55e; }
        .task-list-item.status-failed { border-left-color: #ef4444; background-color: #fef2f2; }
        .log-entry { transition: opacity 0.5s ease; }
        .loader { border: 4px solid #f3f4f6; border-top: 4px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #serverStatus { transition: all 0.3s ease; }
        #confirmationModal, #settingsModal { transition: opacity 0.3s ease; }
        .settings-button { position: absolute; top: 1rem; right: 1rem; z-index: 10; }
        .code-editor { 
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace; 
            background-color: #1e1e1e; 
            color: #d4d4d4; 
            border-radius: 6px; 
            padding: 12px; 
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .code-output {
            background-color: #f5f5f5;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .tool-chain {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .tool-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e9ecef;
        }
        .tool-step:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        .tool-icon {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
            color: white;
        }
        .tool-icon.write { background-color: #4CAF50; }
        .tool-icon.debug { background-color: #FF9800; }
        .tool-icon.run { background-color: #2196F3; }
        .tool-icon.save { background-color: #9C27B0; }
        .tool-icon.think { background-color: #607D8B; }
        .tool-icon.command { background-color: #795548; }
        .tool-content {
            flex-grow: 1;
        }
        .tool-name {
            font-weight: 600;
            margin-bottom: 4px;
        }
        .saved-codes {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 8px;
            background-color: #f9f9f9;
        }
        .saved-code-item {
            padding: 8px;
            margin-bottom: 8px;
            background-color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .saved-code-item:hover {
            background-color: #f0f0f0;
        }
        .saved-code-item.selected {
            background-color: #e3f2fd;
            border: 1px solid #2196F3;
        }
        .custom-model-input {
            margin-top: 8px;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 100%;
            font-size: 14px;
        }
        .api-status {
            padding: 8px 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .api-status.warning {
            background-color: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }
        .api-status.error {
            background-color: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .api-status.success {
            background-color: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .final-report {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-top: 2rem;
        }
        .final-report h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }
        .final-report-content {
            background-color: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- 主容器 -->
    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <header class="text-center mb-8 relative">
            <button id="settingsButton" class="settings-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-md focus:outline-none focus:ring-2 focus:ring-gray-500 transition duration-300 ease-in-out">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379-1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd" /></svg>
            </button>
            <div class="flex justify-center items-center gap-2 mb-2">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">自主任务完成代理</h1>
                <span id="serverStatus" class="h-4 w-4 rounded-full bg-red-500" title="未连接到工具服务器"></span>
            </div>
            <p class="mt-2 text-gray-600">Gemini 模型驱动，支持任务拆分、执行与审阅。</p>
        </header>
        
        <div id="apiStatusContainer"></div>
        
        <div class="mb-6 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-md" role="alert">
            <p class="font-bold">⚠️ 安全警告</p>
            <p>您的 Gemini API Key 将直接在浏览器中用于调用API。请勿在公共网站或不受信任的环境中使用此方法，因为它会暴露您的密钥。此方法仅适用于本地开发或个人项目。</p>
            <input type="password" id="apiKeyInput" placeholder="在此输入你的 Gemini API Key" class="mt-2 w-full p-2 border border-red-300 rounded-md focus:ring-2 focus:ring-red-500 focus:outline-none">
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-md mb-8">
            <div class="flex flex-col md:flex-row gap-4">
                <input type="text" id="mainTaskInput" placeholder="例如：分析一个CSV文件中的销售数据并生成可视化报告" class="flex-grow p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="startButton" class="w-full md:w-auto bg-blue-600 text-white font-semibold py-3 px-6 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-300 ease-in-out flex items-center justify-center disabled:bg-gray-400 disabled:cursor-not-allowed">
                    <span id="buttonText">开始任务</span>
                    <div id="buttonLoader" class="loader ml-2 hidden"></div>
                </button>
            </div>
        </div>
        
        <div id="results" class="space-y-8">
            <section id="planSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">任务计划</h2>
                <div id="planContainer"></div>
            </section>
            
            <section id="executionSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">执行过程</h2>
                <div id="executionContainer"></div>
            </section>
            
            <section id="logSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">执行日志</h2>
                <div id="logContainer" class="p-4 bg-gray-900 text-white rounded-md font-mono text-sm max-h-96 overflow-y-auto space-y-2"></div>
            </section>
            
            <section id="savedCodesSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">已保存的代码</h2>
                <div class="mb-4">
                    <button id="refreshSavedCodesBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition">
                        刷新代码列表
                    </button>
                </div>
                <div id="savedCodesContainer" class="saved-codes"></div>
            </section>
            
            <section id="finalResultSection" class="hidden">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">最终成果</h2>
                <div id="finalResultContainer" class="p-6 bg-white rounded-lg shadow prose max-w-none"></div>
            </section>
            
            <section id="finalReportSection" class="hidden">
                <div class="final-report">
                    <h2>📊 任务完成报告</h2>
                    <div id="finalReportContent" class="final-report-content"></div>
                </div>
            </section>
        </div>
    </div>
    
    <!-- 确认模态框 -->
    <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"><svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg></div>
                <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2">需要你的确认</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">Agent 提议执行以下操作：</p>
                    <div id="modalContent" class="mt-2 text-left bg-gray-100 p-3 rounded-md">
                        <p><strong>工具:</strong> <code id="modalTool" class="text-red-500 font-semibold"></code></p>
                        <p><strong>输入:</strong></p>
                        <pre id="modalQuery" class="whitespace-pre-wrap text-sm bg-gray-800 text-white p-2 rounded mt-1 max-h-40 overflow-y-auto"></pre>
                    </div>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="approveBtn" class="px-4 py-2 bg-green-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300">批准</button>
                    <button id="rejectBtn" class="mt-3 px-4 py-2 bg-red-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-300">拒绝</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 设置模态框 -->
    <div id="settingsModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center hidden z-50">
        <div class="relative mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
            <div class="mt-3">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900">设置</h3>
                    <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-600"><svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
                <div class="space-y-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="text-base font-medium text-gray-900">自动批准</h4>
                            <p class="text-sm text-gray-500">启用后将自动批准所有工具使用请求</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="autoApproveToggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-base font-medium text-gray-900">模型选择</h4>
                        <div>
                            <label for="planningModel" class="block text-sm font-medium text-gray-700 mb-1">任务规划模型</label>
                            <select id="planningModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (推荐)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">自定义模型</option>
                            </select>
                            <input type="text" id="customPlanningModel" class="custom-model-input hidden" placeholder="输入自定义模型名称，如: gemini-1.5-flash-latest">
                        </div>
                        <div>
                            <label for="executionModel" class="block text-sm font-medium text-gray-700 mb-1">任务执行模型</label>
                            <select id="executionModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (推荐)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">自定义模型</option>
                            </select>
                            <input type="text" id="customExecutionModel" class="custom-model-input hidden" placeholder="输入自定义模型名称，如: gemini-1.5-flash-latest">
                        </div>
                        <div>
                            <label for="reviewModel" class="block text-sm font-medium text-gray-700 mb-1">结果审阅模型</label>
                            <select id="reviewModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (推荐)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">自定义模型</option>
                            </select>
                            <input type="text" id="customReviewModel" class="custom-model-input hidden" placeholder="输入自定义模型名称，如: gemini-1.5-flash-latest">
                        </div>
                        <div>
                            <label for="outputModel" class="block text-sm font-medium text-gray-700 mb-1">输出总结模型</label>
                            <select id="outputModel" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (推荐)</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="custom">自定义模型</option>
                            </select>
                            <input type="text" id="customOutputModel" class="custom-model-input hidden" placeholder="输入自定义模型名称，如: gemini-1.5-flash-latest">
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-base font-medium text-gray-900">API设置</h4>
                        <div>
                            <label for="apiRequestDelay" class="block text-sm font-medium text-gray-700 mb-1">API请求间隔(秒)</label>
                            <input type="number" id="apiRequestDelay" min="1" max="60" value="6" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">增加此值可以避免API速率限制错误</p>
                        </div>
                        <div>
                            <label for="maxRetries" class="block text-sm font-medium text-gray-700 mb-1">最大重试次数</label>
                            <input type="number" id="maxRetries" min="1" max="10" value="3" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button id="saveSettingsBtn" class="w-full px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">保存设置</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- [FIX] Wrap all code in DOMContentLoaded listener to ensure libraries are loaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM 元素 ---
            const apiKeyInput = document.getElementById('apiKeyInput');
            const mainTaskInput = document.getElementById('mainTaskInput');
            const startButton = document.getElementById('startButton');
            const buttonText = document.getElementById('buttonText');
            const buttonLoader = document.getElementById('buttonLoader');
            const serverStatus = document.getElementById('serverStatus');
            const planSection = document.getElementById('planSection');
            const planContainer = document.getElementById('planContainer');
            const executionSection = document.getElementById('executionSection');
            const executionContainer = document.getElementById('executionContainer');
            const logSection = document.getElementById('logSection');
            const logContainer = document.getElementById('logContainer');
            const savedCodesSection = document.getElementById('savedCodesSection');
            const savedCodesContainer = document.getElementById('savedCodesContainer');
            const refreshSavedCodesBtn = document.getElementById('refreshSavedCodesBtn');
            const finalResultSection = document.getElementById('finalResultSection');
            const finalResultContainer = document.getElementById('finalResultContainer');
            const finalReportSection = document.getElementById('finalReportSection');
            const finalReportContent = document.getElementById('finalReportContent');
            const confirmationModal = document.getElementById('confirmationModal');
            const modalTool = document.getElementById('modalTool');
            const modalQuery = document.getElementById('modalQuery');
            const approveBtn = document.getElementById('approveBtn');
            const rejectBtn = document.getElementById('rejectBtn');
            const settingsButton = document.getElementById('settingsButton');
            const settingsModal = document.getElementById('settingsModal');
            const closeSettingsBtn = document.getElementById('closeSettingsBtn');
            const saveSettingsBtn = document.getElementById('saveSettingsBtn');
            const autoApproveToggle = document.getElementById('autoApproveToggle');
            const planningModel = document.getElementById('planningModel');
            const executionModel = document.getElementById('executionModel');
            const reviewModel = document.getElementById('reviewModel');
            const outputModel = document.getElementById('outputModel');
            const customPlanningModel = document.getElementById('customPlanningModel');
            const customExecutionModel = document.getElementById('customExecutionModel');
            const customReviewModel = document.getElementById('customReviewModel');
            const customOutputModel = document.getElementById('customOutputModel');
            const apiRequestDelay = document.getElementById('apiRequestDelay');
            const maxRetries = document.getElementById('maxRetries');
            const apiStatusContainer = document.getElementById('apiStatusContainer');
            
            // --- 状态管理 ---
            let state = {};
            const toolResponses = new Map();
            let modalResolver = null;
            let savedCodes = {}; // 保存的代码
            let selectedCodeId = null; // 当前选中的代码ID
            let apiCallCount = 0; // API调用计数
            let lastApiCallTime = 0; // 上次API调用时间
            let apiErrorCount = 0; // API错误计数
            let executionHistory = []; // 存储每个任务的执行历史
            
            // --- 默认模型组设为 gemini-2.0 系列 ---
            let settings = {
                autoApprove: false,
                planningModel: 'gemini-2.0-flash-exp',
                executionModel: 'gemini-2.0-flash-exp',
                reviewModel: 'gemini-2.0-flash-exp',
                outputModel: 'gemini-2.0-flash-exp',
                customPlanningModel: '',
                customExecutionModel: '',
                customReviewModel: '',
                customOutputModel: '',
                apiRequestDelay: 6, // 默认6秒间隔
                maxRetries: 3 // 默认最大重试3次
            };
            
            function loadSettings() {
                const savedSettings = localStorage.getItem('agentSettings');
                if (savedSettings) {
                    try {
                        settings = JSON.parse(savedSettings);
                        autoApproveToggle.checked = settings.autoApprove;
                        
                        // 设置规划模型
                        if (settings.customPlanningModel) {
                            planningModel.value = 'custom';
                            customPlanningModel.value = settings.customPlanningModel;
                            customPlanningModel.classList.remove('hidden');
                        } else {
                            planningModel.value = settings.planningModel;
                        }
                        
                        // 设置执行模型
                        if (settings.customExecutionModel) {
                            executionModel.value = 'custom';
                            customExecutionModel.value = settings.customExecutionModel;
                            customExecutionModel.classList.remove('hidden');
                        } else {
                            executionModel.value = settings.executionModel;
                        }
                        
                        // 设置审阅模型
                        if (settings.customReviewModel) {
                            reviewModel.value = 'custom';
                            customReviewModel.value = settings.customReviewModel;
                            customReviewModel.classList.remove('hidden');
                        } else {
                            reviewModel.value = settings.reviewModel;
                        }
                        
                        // 设置输出模型
                        if (settings.customOutputModel) {
                            outputModel.value = 'custom';
                            customOutputModel.value = settings.customOutputModel;
                            customOutputModel.classList.remove('hidden');
                        } else {
                            outputModel.value = settings.outputModel || 'gemini-2.0-flash-exp';
                        }
                        
                        // 设置API参数
                        apiRequestDelay.value = settings.apiRequestDelay || 6;
                        maxRetries.value = settings.maxRetries || 3;
                    } catch (e) { console.error('加载设置失败:', e); }
                }
            }
            
            function saveSettings() {
                settings.autoApprove = autoApproveToggle.checked;
                
                // 保存规划模型
                if (planningModel.value === 'custom') {
                    settings.customPlanningModel = customPlanningModel.value;
                    settings.planningModel = '';
                } else {
                    settings.planningModel = planningModel.value;
                    settings.customPlanningModel = '';
                }
                
                // 保存执行模型
                if (executionModel.value === 'custom') {
                    settings.customExecutionModel = customExecutionModel.value;
                    settings.executionModel = '';
                } else {
                    settings.executionModel = executionModel.value;
                    settings.customExecutionModel = '';
                }
                
                // 保存审阅模型
                if (reviewModel.value === 'custom') {
                    settings.customReviewModel = customReviewModel.value;
                    settings.reviewModel = '';
                } else {
                    settings.reviewModel = reviewModel.value;
                    settings.customReviewModel = '';
                }
                
                // 保存输出模型
                if (outputModel.value === 'custom') {
                    settings.customOutputModel = customOutputModel.value;
                    settings.outputModel = '';
                } else {
                    settings.outputModel = outputModel.value;
                    settings.customOutputModel = '';
                }
                
                // 保存API参数
                settings.apiRequestDelay = parseInt(apiRequestDelay.value) || 6;
                settings.maxRetries = parseInt(maxRetries.value) || 3;
                
                localStorage.setItem('agentSettings', JSON.stringify(settings));
            }
            
            function getModelName(selectElement, customInput) {
                if (selectElement.value === 'custom') {
                    return customInput.value || 'gemini-2.0-flash-exp';
                }
                return selectElement.value;
            }
            
            // 显示API状态
            function showApiStatus(message, type = 'warning') {
                apiStatusContainer.innerHTML = `
                    <div class="api-status ${type}">
                        ${message}
                    </div>
                `;
                
                // 5秒后自动隐藏
                setTimeout(() => {
                    apiStatusContainer.innerHTML = '';
                }, 5000);
            }
            
            // --- WebSocket 连接 (仅用于工具服务器) ---
            const socket = io("http://127.0.0.1:5000");
            socket.on('connect', () => {
                serverStatus.classList.remove('bg-red-500');
                serverStatus.classList.add('bg-green-500');
                serverStatus.title = "已连接到工具服务器";
            });
            socket.on('disconnect', () => {
                serverStatus.classList.remove('bg-green-500');
                serverStatus.classList.add('bg-red-500');
                serverStatus.title = "未连接到工具服务器";
            });
            socket.on('tool_result', (data) => {
                const resolver = toolResponses.get(data.request_id);
                if (resolver) {
                    resolver(data);
                    toolResponses.delete(data.request_id);
                }
            });
            
            // --- 核心 Agent 逻辑 ---
            async function runAgent() {
                if (state.isBusy) return;
                initializeState();
                if (!validateInputs()) return;
                setBusy(true);
                try {
                    await logStep("1. 开始分析任务并拆分为切实可行的任务块...", "🧠");
                    const plan = await decomposeTask(state.mainTask);
                    if (!Array.isArray(plan) || plan.length === 0) {
                        await logStep("解析到的计划为空或不是数组，终止执行。", "❌");
                        throw new Error("解析到的计划为空或不是数组。检查模型返回原文以定位问题。");
                    }
                    state.plan = plan;
                    displayPlan();
                    await logStep(`   计划制定完毕，共 ${plan.length} 个任务块。`, "✅");
                    
                    // 依次执行每个任务块
                    for (let taskIndex = 0; taskIndex < state.plan.length; taskIndex++) {
                        const task = state.plan[taskIndex];
                        const result = await executeTaskBlock(task, taskIndex);
                        
                        // 检查是否重新规划了
                        if (result && result.replanned) {
                            // 重置任务索引，重新开始执行
                            taskIndex = -1;
                            await logStep(`重新规划完成，从第一个任务开始执行`, "🔄");
                            continue;
                        }
                    }
                    
                    await finalizeTask();
                } catch (error) {
                    await handleFatalError(error);
                }
            }
            
            async function executeTaskBlock(task, taskIndex) {
                const taskId = `task-${taskIndex}`;
                updateTaskStatus(taskId, 'running');
                await logStep(`\n开始执行任务块 #${taskIndex + 1}: "${task}"`, "🚀");
                
                // 创建执行过程显示区域
                const executionDiv = createExecutionDisplay(taskIndex, task);
                executionContainer.appendChild(executionDiv);
                executionSection.classList.remove('hidden');
                
                const maxRetriesCount = parseInt(settings.maxRetries) || 3;
                let lastOutput = '';
                let lastFeedback = '';
                let taskExecutionHistory = {
                    taskIndex,
                    task,
                    toolChain: [],
                    output: '',
                    status: 'running'
                };
                
                for (let retryCount = 0; retryCount <= maxRetriesCount; retryCount++) {
                    if (retryCount > 0) {
                        await logStep(`  [任务 ${taskIndex + 1}] 第 ${retryCount} 次尝试修正...`, "🛠️");
                    }
                    try {
                        // 执行AI决策并执行
                        const result = await executeAITask(task, taskIndex, retryCount, executionDiv, taskExecutionHistory);
                        
                        // 检查是否重新规划了
                        if (result.replanned) {
                            // 重新开始执行整个任务
                            await logStep(`任务已重新规划，重新开始执行...`, "🔄");
                            return { replanned: true, newPlan: result.newPlan };
                        }
                        
                        lastOutput = result.output;
                        taskExecutionHistory.output = result.output;
                        
                        // 审阅AI评估结果
                        await logStep(`  [任务 ${taskIndex + 1}] 交给审阅AI评估...`, "🧐");
                        const reviewResult = await reviewTaskResult(task, result.output);
                        
                        if (reviewResult.passed) {
                            await logStep(`  [任务 ${taskIndex + 1}] 审阅通过！`, "✅");
                            state.completedOutputs.push({ task, output: result.output });
                            taskExecutionHistory.status = 'completed';
                            updateTaskStatus(taskId, 'completed');
                            updateExecutionDisplay(executionDiv, 'completed', result.output);
                            executionHistory.push(taskExecutionHistory);
                            return;
                        } else {
                            lastFeedback = reviewResult.feedback;
                            await logStep(`  [任务 ${taskIndex + 1}] 审阅不通过。反馈: ${lastFeedback}`, "👎");
                            updateExecutionDisplay(executionDiv, 'failed', result.output, lastFeedback);
                            
                            if (retryCount >= maxRetriesCount) {
                                taskExecutionHistory.status = 'failed';
                                taskExecutionHistory.error = lastFeedback;
                                executionHistory.push(taskExecutionHistory);
                                throw new Error(`任务 "${task}" 在 ${maxRetriesCount} 次重试后仍然未通过审阅。`);
                            }
                        }
                    } catch (error) {
                        console.error(`任务 ${taskIndex + 1} 执行错误:`, error);
                        const errorMessage = error.message || '未知错误';
                        await logStep(`  [任务 ${taskIndex + 1}] 执行错误: ${errorMessage}`, "❌");
                        lastFeedback = `执行过程中发生异常: ${errorMessage}`;
                        lastOutput = `[异常] ${errorMessage}`;
                        
                        if (retryCount >= maxRetriesCount) {
                            taskExecutionHistory.status = 'failed';
                            taskExecutionHistory.error = errorMessage;
                            executionHistory.push(taskExecutionHistory);
                            updateTaskStatus(taskId, 'failed');
                            updateExecutionDisplay(executionDiv, 'failed', lastOutput, lastFeedback);
                            throw error;
                        }
                    }
                }
                
                taskExecutionHistory.status = 'failed';
                taskExecutionHistory.error = lastFeedback;
                executionHistory.push(taskExecutionHistory);
                updateTaskStatus(taskId, 'failed');
                updateExecutionDisplay(executionDiv, 'failed', lastOutput, lastFeedback);
                throw new Error(`任务 "${task}" 在 ${maxRetriesCount} 次重试后仍然失败。`);
            }
            
            async function executeAITask(task, taskIndex, retryCount, executionDiv, taskExecutionHistory) {
                await logStep(`  [任务 ${taskIndex + 1}] 执行AI开始处理...`, "🤖");
                
                let currentCode = '';
                let toolChain = [];
                let isCompleted = false;
                let result = '';
                
                while (!isCompleted) {
                    // 执行AI决策
                    const decision = await makeExecutionDecision(task, currentCode, toolChain, retryCount);
                    toolChain.push(decision);
                    taskExecutionHistory.toolChain.push(decision);
                    
                    // 显示工具链步骤
                    addToolChainStep(executionDiv, decision);
                    
                    if (decision.action === 'think') {
                        // 直接思考输出
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI直接思考输出...`, "💭");
                        result = decision.output;
                        isCompleted = true;
                    } else if (decision.action === 'replan') {
                        // 重新规划任务
                        await logStep(`  [任务 ${taskIndex + 1}] AI决定重新规划任务...`, "🔄");
                        
                        if (decision.newPlan && Array.isArray(decision.newPlan)) {
                            // 更新任务计划
                            state.plan = decision.newPlan;
                            displayPlan();
                            
                            // 重新开始执行
                            await logStep(`任务已重新规划，共 ${decision.newPlan.length} 个任务块`, "✅");
                            
                            // 返回特殊标记，表示需要重新开始
                            return { 
                                output: '任务已重新规划', 
                                toolChain,
                                replanned: true,
                                newPlan: decision.newPlan
                            };
                        } else {
                            await logStep(`重新规划失败：未提供有效的新计划`, "❌");
                        }
                    } else if (decision.action === 'write_code') {
                        // 编写代码
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI编写代码...`, "📝");
                        currentCode = decision.code;
                    } else if (decision.action === 'debug_code') {
                        // 调试代码
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI调试代码...`, "🐛");
                        currentCode = decision.code;
                    } else if (decision.action === 'run_code') {
                        // 运行代码
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI运行代码...`, "▶️");
                        const runResult = await runPythonCode(currentCode);
                        decision.runResult = runResult;
                        
                        // 更新工具链显示
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (runResult.error) {
                            await logStep(`  [任务 ${taskIndex + 1}] 代码运行出错: ${runResult.error}`, "❌");
                        } else {
                            await logStep(`  [任务 ${taskIndex + 1}] 代码运行成功`, "✅");
                        }
                    } else if (decision.action === 'run_command') {
                        // 运行命令行
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI运行命令行...`, "💻");
                        const runResult = await runCommand(decision.command);
                        decision.runResult = runResult;
                        
                        // 更新工具链显示
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (runResult.error) {
                            await logStep(`  [任务 ${taskIndex + 1}] 命令行执行出错: ${runResult.error}`, "❌");
                        } else {
                            await logStep(`  [任务 ${taskIndex + 1}] 命令行执行成功`, "✅");
                        }
                    } else if (decision.action === 'save_code') {
                        // 保存代码 - 通过后端API
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI保存代码...`, "💾");
                        const saveResult = await saveCodeToBackend(decision.name || `代码块_${Date.now()}`, currentCode);
                        decision.saveResult = saveResult;
                        
                        // 更新工具链显示
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (saveResult.success) {
                            await logStep(`  [任务 ${taskIndex + 1}] 代码保存成功，ID: ${saveResult.codeId}`, "✅");
                            // 刷新保存的代码列表
                            await loadSavedCodes();
                        } else {
                            await logStep(`  [任务 ${taskIndex + 1}] 代码保存失败: ${saveResult.error}`, "❌");
                        }
                    } else if (decision.action === 'run_saved_code') {
                        // 运行已保存的代码 - 通过后端API
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI运行已保存的代码...`, "📂");
                        const runResult = await runSavedCodeFromBackend(decision.codeId);
                        decision.runResult = runResult;
                        
                        // 更新工具链显示
                        updateToolChainStep(executionDiv, toolChain.length - 1, decision);
                        
                        if (runResult.success) {
                            if (runResult.error) {
                                await logStep(`  [任务 ${taskIndex + 1}] 代码运行出错: ${runResult.error}`, "❌");
                            } else {
                                await logStep(`  [任务 ${taskIndex + 1}] 代码运行成功`, "✅");
                            }
                        } else {
                            await logStep(`  [任务 ${taskIndex + 1}] 无法运行代码: ${runResult.error}`, "❌");
                        }
                    } else if (decision.action === 'complete') {
                        // 完成任务
                        await logStep(`  [任务 ${taskIndex + 1}] 执行AI认为任务已完成`, "🏁");
                        result = decision.output || currentCode;
                        isCompleted = true;
                    }
                }
                
                return { output: result, toolChain };
            }
            
            async function makeExecutionDecision(task, currentCode, toolChain, retryCount) {
                // 首先获取已保存的代码列表，以便AI决策
                const savedCodesList = await getSavedCodesList();
                
                const toolDescriptions = `
- think: 直接思考并输出结果，不使用任何工具
- write_code: 编写新的Python代码
- debug_code: 调试现有Python代码
- run_code: 运行当前Python代码
- run_command: 运行命令行指令（如ls, dir, pip install等）
- save_code: 保存当前代码到后端
- run_saved_code: 运行已保存的代码
- replan: 重新规划整个任务（当发现当前计划不合适时）
- complete: 认为任务已完成，输出最终结果
`;
                
                const context = {
                    task,
                    currentCode: currentCode || '无',
                    toolChain: toolChain.map(step => ({
                        action: step.action,
                        input: step.input || '',
                        output: step.output || '',
                        runResult: step.runResult || null,
                        saveResult: step.saveResult || null
                    })),
                    retryCount,
                    savedCodes: savedCodesList
                };
                
                const prompt = `你是一个执行AI，负责完成具体的任务块。

当前任务: "${task}"

当前代码:
 ${currentCode || '无'}

已执行的工具链:
 ${JSON.stringify(context.toolChain, null, 2)}

已保存的代码列表:
 ${JSON.stringify(context.savedCodes, null, 2)}

请根据当前状态，决定下一步行动。可用工具:
 ${toolDescriptions}

重要提示：
1. 如果发现当前任务无法完成，或者需要重新规划整个任务，请使用 replan 工具
2. 重新规划时，请给出"简略但不简陋"的计划 - 即简洁但包含所有必要步骤
3. 只有在确实需要重新规划时才使用 replan 工具，不要滥用
4. 你可以使用 run_command 工具执行系统命令，如文件操作、安装包等
5. 使用 run_command 时要确保命令安全，避免破坏性操作

请严格按照以下JSON格式返回你的决策:
{
  "action": "工具名称",
  "input": "工具输入（如果需要）",
  "output": "输出内容（如果action是think或complete）",
  "code": "代码内容（如果action是write_code或debug_code）",
  "command": "命令行指令（如果action是run_command）",
  "name": "代码名称（如果action是save_code）",
  "codeId": "代码ID（如果action是run_saved_code）",
  "newPlan": ["新任务1", "新任务2", "新任务3"], // 如果action是replan
  "reasoning": "决策理由"
}`;
                
                const modelName = getModelName(executionModel, customExecutionModel);
                const decisionStr = await callGemini(prompt, true, modelName);
                return JSON.parse(decisionStr);
            }
            
            async function reviewTaskResult(task, output) {
                const prompt = `你是一个严格的审阅AI，负责评估任务执行结果。

原始任务: "${task}"

执行结果:
 ${output}

请评估执行结果是否高质量地完成了任务。返回JSON格式:
{
  "passed": true/false,
  "feedback": "详细反馈意见",
  "score": 0-100
}`;
                
                const modelName = getModelName(reviewModel, customReviewModel);
                const reviewStr = await callGemini(prompt, true, modelName);
                return JSON.parse(reviewStr);
            }
            
            async function generateFinalReport() {
                await logStep("\n正在生成最终报告...", "📝");
                
                const prompt = `你是一个专业的输出师，负责整合所有信息并生成最终的任务完成报告。

用户原始需求: "${state.mainTask}"

任务规划: ${JSON.stringify(state.plan, null, 2)}

执行历史: ${JSON.stringify(executionHistory, null, 2)}

任务完成结果: ${JSON.stringify(state.completedOutputs, null, 2)}

请根据用户原始需求，用可可爱爱的语气，整合各个地方的输出，给出最终输出。简短有力！
请直接生成报告内容，不需要JSON格式。`;
                
                const modelName = getModelName(outputModel, customOutputModel);
                const report = await callGemini(prompt, false, modelName);
                
                // 显示最终报告
                finalReportContent.innerHTML = `
                    <div class="prose prose-invert max-w-none">
                        ${report.replace(/\n/g, '<br>')}
                    </div>
                `;
                finalReportSection.classList.remove('hidden');
                
                await logStep("最终报告生成完成！", "✅");
            }
            
            async function finalizeTask() {
                await logStep("\n所有任务块执行完毕，正在整合最终成果...", "🎉");
                const finalResult = state.completedOutputs.map(item => `<h3>${item.task}</h3>\n\n<pre class="whitespace-pre-wrap text-sm bg-gray-100 p-4 rounded-md">${item.output.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`).join('\n\n---\n\n');
                finalResultContainer.innerHTML = finalResult;
                finalResultSection.classList.remove('hidden');
                
                // 生成最终报告
                await generateFinalReport();
                
                await logStep("任务全部完成！", "🏆");
                setBusy(false);
            }

            // --- 后端API调用 ---
            async function saveCodeToBackend(name, code) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/save_code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name, code })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`保存代码失败: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return { success: true, codeId: result.code_id, message: result.message };
                } catch (error) {
                    console.error('保存代码错误:', error);
                    return { success: false, error: error.message };
                }
            }
            
            async function getSavedCodesList() {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/saved_codes');
                    
                    if (!response.ok) {
                        throw new Error(`获取代码列表失败: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return result.codes || [];
                } catch (error) {
                    console.error('获取代码列表错误:', error);
                    // 不显示错误，因为后端可能没有运行
                    return [];
                }
            }
            
            async function runSavedCodeFromBackend(codeId) {
                try {
                    const response = await fetch('http://127.0.0.1:8000/api/run_saved_code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ code_id: codeId })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`运行保存的代码失败: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    return { 
                        success: true, 
                        output: result.output, 
                        error: result.error,
                        return_code: result.return_code,
                        execution_time: result.execution_time
                    };
                } catch (error) {
                    console.error('运行保存的代码错误:', error);
                    return { success: false, error: error.message };
                }
            }
            
            async function loadSavedCodes() {
                savedCodes = await getSavedCodesList();
                updateSavedCodesDisplay();
            }
            
            // --- 工具和API调用 ---
            async function runPythonCode(code) {
                return new Promise((resolve) => {
                    const request_id = Date.now() + Math.random().toString();
                    toolResponses.set(request_id, resolve);
                    socket.emit('use_tool', { tool: 'run_code', query: code, request_id });
                });
            }
            
            async function runCommand(command) {
                return new Promise((resolve) => {
                    const request_id = Date.now() + Math.random().toString();
                    toolResponses.set(request_id, resolve);
                    socket.emit('use_tool', { tool: 'run_command', query: command, request_id });
                });
            }

            async function decomposeTask(task) {
                const prompt = `你是一个任务规划AI，负责将用户任务拆分为切实可行的任务块。

用户任务: "${task}"

执行AI拥有以下强大能力：
1. 可以编写并运行Python代码（包括数学计算、数据处理、文件操作等）
2. 可以执行系统命令（如ls、dir、pip install、git等）
3. 可以保存和重用代码
4. 可以直接思考并给出答案

请将任务拆分为一系列高层次的、具体的任务块。每个任务块应该是一个明确的步骤，但不要过于细化执行细节。

重要原则：
1. 任务块要高层次的、具体的，避免描述执行细节
2. 充分利用执行AI的能力，将复杂的计算或操作合并为一个任务块
3. 保持"简略但不简陋" - 即简洁但包含所有必要步骤
4. 避免将可以一步完成的操作拆分成多个步骤

错误的例子（过于细化）：
对于"12345213432321是不是素数"，不应该拆分为：
1. 获取待检测的数字
2. 进行基本排除
3. 计算平方根
4. 试除法检查
5. 判断结果

正确的例子（简洁高效）：
对于"12345213432321是不是素数"，应该拆分为：
1. 编写代码检测该数字是否为素数

请只返回JSON数组，格式如下:
[
  "任务块1",
  "任务块2",
  "任务块3"
]

例如，对于"分析一个CSV文件中的销售数据并生成可视化报告"，应该返回:
[
  "查找并加载CSV文件",
  "使用Python分析数据并生成可视化图表",
  "创建分析报告"
]`;
                
                const modelName = getModelName(planningModel, customPlanningModel);
                const raw = await callGemini(prompt, true, modelName);
                await logStep(`模型规划返回: ${String(raw).slice(0,1000)}`, "📄");

                function safeParseModelJson(text) {
                    if (typeof text !== 'string') return text;
                    const cleanedText = text.replace(/```(?:json)?/gi, '').replace(/```/g, '').trim();
                    try {
                        return JSON.parse(cleanedText);
                    } catch (e) {
                        console.error("JSON 解析失败:", e, "原始文本:", text);
                        throw new Error("无法将模型返回解析为 JSON。返回预览: " + text.slice(0, 500));
                    }
                }
                return safeParseModelJson(raw);
            }

            async function callGemini(prompt, useJson = false, model = 'gemini-2.0-flash-exp') {
                // 实现API调用速率限制
                const now = Date.now();
                const timeSinceLastCall = now - lastApiCallTime;
                const minDelay = (settings.apiRequestDelay || 6) * 1000; // 转换为毫秒
                
                if (timeSinceLastCall < minDelay) {
                    const waitTime = minDelay - timeSinceLastCall;
                    await new Promise(resolve => setTimeout(resolve, waitTime));
                }
                
                lastApiCallTime = Date.now();
                apiCallCount++;
                
                const maxRetriesCount = parseInt(settings.maxRetries) || 3;
                let lastError = null;
                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${state.apiKey}`;
                
                for (let attempt = 1; attempt <= maxRetriesCount; attempt++) {
                    try {
                        const payload = { contents: [{ parts: [{ text: prompt }] }] };
                        if (useJson) {
                            payload.generationConfig = { responseMimeType: "application/json" };
                        }
                        
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            let errorBodyText = await response.text();
                            let errorMessage = `API 请求失败: ${response.status}.`;
                            try {
                               const errorBody = JSON.parse(errorBodyText);
                               errorMessage += ` ${errorBody.error?.message || '未知错误'}`;
                               
                               // 检查是否是速率限制错误
                               if (response.status === 429) {
                                   const retryAfter = errorBody.error?.details?.[0]?.retryAfter?.seconds || 60;
                                   errorMessage += ` 请在 ${retryAfter} 秒后重试。`;
                                   
                                   // 显示API状态
                                   showApiStatus(`API速率限制已达到，请在 ${retryAfter} 秒后重试`, 'error');
                                   
                                   // 如果是速率限制，等待指定时间后重试
                                   if (attempt < maxRetriesCount) {
                                       await new Promise(resolve => setTimeout(resolve, retryAfter * 1000));
                                       continue;
                                   }
                               } else if (response.status === 503) {
                                   errorMessage += ` 模型过载，请稍后重试。`;
                                   showApiStatus('模型过载，请稍后重试', 'warning');
                               }
                            } catch(e) {
                               errorMessage += ` 响应内容: ${errorBodyText}`;
                            }
                            throw new Error(errorMessage);
                        }
                        
                        const data = await response.json();
                        
                        if (data.candidates && data.candidates.length > 0 && data.candidates[0]?.content?.parts?.[0]) {
                            // 重置错误计数
                            apiErrorCount = 0;
                            return data.candidates[0].content.parts[0].text;
                        }
                        
                        if (data.promptFeedback) {
                            throw new Error(`请求被模型阻止，原因: ${data.promptFeedback?.blockReason || '未知'}. 详情: ${JSON.stringify(data.promptFeedback.safetyRatings)}`);
                        }

                        throw new Error("API返回了意料之外的空内容。");

                    } catch (error) {
                        lastError = error;
                        apiErrorCount++;
                        console.warn(`Gemini API 调用失败 (尝试 ${attempt}/${maxRetriesCount}):`, error);
                        
                        // 如果连续错误超过5次，显示警告
                        if (apiErrorCount >= 5) {
                            showApiStatus('API连续调用失败，请检查网络连接或API密钥', 'error');
                        }
                        
                        if (attempt < maxRetriesCount) {
                            // 指数退避重试
                            const delay = Math.min(Math.pow(2, attempt) * 1000, 30000); // 最大30秒
                            await logStep(`API 调用失败，${delay/1000}秒后重试...`, "⏱️");
                            await new Promise(resolve => setTimeout(resolve, delay));
                        }
                    }
                }
                
                throw lastError || new Error('Gemini API 调用在多次重试后仍然失败');
            }
            
            // --- UI 辅助函数 ---
            function createExecutionDisplay(taskIndex, task) {
                const div = document.createElement('div');
                div.className = 'mb-6 p-4 bg-white rounded-lg shadow';
                div.id = `execution-${taskIndex}`;
                
                div.innerHTML = `
                    <h3 class="text-lg font-semibold mb-3">任务块 #${taskIndex + 1}: ${task}</h3>
                    <div class="tool-chain" id="tool-chain-${taskIndex}">
                        <div class="text-gray-500 text-sm">等待执行...</div>
                    </div>
                    <div class="mt-4">
                        <div class="text-sm font-medium text-gray-700 mb-2">最终结果:</div>
                        <div id="result-${taskIndex}" class="text-gray-500 text-sm">等待完成...</div>
                    </div>
                `;
                
                return div;
            }
            
            function addToolChainStep(executionDiv, decision) {
                const taskIndex = executionDiv.id.split('-')[1];
                const toolChainDiv = document.getElementById(`tool-chain-${taskIndex}`);
                
                // 清除初始提示
                if (toolChainDiv.querySelector('.text-gray-500')) {
                    toolChainDiv.innerHTML = '';
                }
                
                const stepDiv = document.createElement('div');
                stepDiv.className = 'tool-step';
                stepDiv.id = `step-${taskIndex}-${Date.now()}`;
                
                let iconClass = '';
                let iconText = '';
                
                switch (decision.action) {
                    case 'think':
                        iconClass = 'think';
                        iconText = '💭';
                        break;
                    case 'write_code':
                        iconClass = 'write';
                        iconText = '📝';
                        break;
                    case 'debug_code':
                        iconClass = 'debug';
                        iconText = '🐛';
                        break;
                    case 'run_code':
                        iconClass = 'run';
                        iconText = '▶️';
                        break;
                    case 'run_command':
                        iconClass = 'command';
                        iconText = '💻';
                        break;
                    case 'save_code':
                        iconClass = 'save';
                        iconText = '💾';
                        break;
                    case 'run_saved_code':
                        iconClass = 'run';
                        iconText = '📂';
                        break;
                    case 'replan':
                        iconClass = 'think';
                        iconText = '🔄';
                        break;
                    case 'complete':
                        iconClass = 'think';
                        iconText = '🏁';
                        break;
                    default:
                        iconClass = 'think';
                        iconText = '❓';
                }
                
                let content = '';
                
                if (decision.action === 'think' || decision.action === 'complete') {
                    content = `
                        <div class="tool-name">${decision.action === 'think' ? '思考' : '完成'}</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">输出:</div>
                            <div class="text-sm mt-1 p-2 bg-gray-100 rounded">${decision.output || ''}</div>
                        </div>
                    `;
                } else if (decision.action === 'replan') {
                    content = `
                        <div class="tool-name">重新规划</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">新计划:</div>
                            <div class="text-sm mt-1 p-2 bg-gray-100 rounded">
                                <ol class="list-decimal list-inside">
                                    ${(decision.newPlan || []).map(item => `<li>${item}</li>`).join('')}
                                </ol>
                            </div>
                        </div>
                    `;
                } else if (decision.action === 'write_code' || decision.action === 'debug_code') {
                    content = `
                        <div class="tool-name">${decision.action === 'write_code' ? '编写代码' : '调试代码'}</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">代码:</div>
                            <div class="code-editor mt-1">${decision.code || ''}</div>
                        </div>
                    `;
                } else if (decision.action === 'run_code') {
                    content = `
                        <div class="tool-name">运行代码</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">运行结果:</div>
                            <div class="text-sm mt-1 text-gray-500">等待运行结果...</div>
                        </div>
                    `;
                } else if (decision.action === 'run_command') {
                    content = `
                        <div class="tool-name">运行命令</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">命令:</div>
                            <div class="code-editor mt-1">${decision.command || ''}</div>
                            <div class="text-sm mt-1 text-gray-500">等待执行结果...</div>
                        </div>
                    `;
                } else if (decision.action === 'save_code') {
                    content = `
                        <div class="tool-name">保存代码</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">保存为: ${decision.name || '未命名'}</div>
                            <div class="text-sm mt-1 text-gray-500">等待保存结果...</div>
                        </div>
                    `;
                } else if (decision.action === 'run_saved_code') {
                    content = `
                        <div class="tool-name">运行已保存代码</div>
                        <div class="text-sm text-gray-600">${decision.reasoning || ''}</div>
                        <div class="mt-2">
                            <div class="text-sm font-medium text-gray-700">代码ID: ${decision.codeId || ''}</div>
                            <div class="text-sm mt-1 text-gray-500">等待运行结果...</div>
                        </div>
                    `;
                }
                
                stepDiv.innerHTML = `
                    <div class="tool-icon ${iconClass}">${iconText}</div>
                    <div class="tool-content">${content}</div>
                `;
                
                toolChainDiv.appendChild(stepDiv);
            }
            
            function updateToolChainStep(executionDiv, stepIndex, decision) {
                const taskIndex = executionDiv.id.split('-')[1];
                const toolChainDiv = document.getElementById(`tool-chain-${taskIndex}`);
                const steps = toolChainDiv.querySelectorAll('.tool-step');
                const stepDiv = steps[stepIndex];
                
                if (!stepDiv) return;
                
                if (decision.action === 'run_code') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.runResult) {
                        if (decision.runResult.error) {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">运行出错:</div>
                                <div class="code-output mt-1">${decision.runResult.error}</div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-green-600 font-medium">运行成功:</div>
                                <div class="code-output mt-1">${decision.runResult.result || ''}</div>
                            `;
                        }
                    }
                } else if (decision.action === 'run_command') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.runResult) {
                        if (decision.runResult.error) {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">执行出错:</div>
                                <div class="code-output mt-1">${decision.runResult.error}</div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-green-600 font-medium">执行成功:</div>
                                <div class="code-output mt-1">${decision.runResult.result || ''}</div>
                            `;
                        }
                    }
                } else if (decision.action === 'save_code') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.saveResult) {
                        if (decision.saveResult.success) {
                            resultDiv.innerHTML = `
                                <div class="text-green-600 font-medium">保存成功:</div>
                                <div class="text-sm mt-1">代码ID: ${decision.saveResult.codeId}</div>
                            `;
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">保存失败:</div>
                                <div class="text-sm mt-1">${decision.saveResult.error}</div>
                            `;
                        }
                    }
                } else if (decision.action === 'run_saved_code') {
                    const resultDiv = stepDiv.querySelector('.tool-content .text-gray-500');
                    if (resultDiv && decision.runResult) {
                        if (decision.runResult.success) {
                            if (decision.runResult.error) {
                                resultDiv.innerHTML = `
                                    <div class="text-red-600 font-medium">运行出错:</div>
                                    <div class="code-output mt-1">${decision.runResult.error}</div>
                                `;
                            } else {
                                resultDiv.innerHTML = `
                                    <div class="text-green-600 font-medium">运行成功:</div>
                                    <div class="code-output mt-1">${decision.runResult.output || ''}</div>
                                `;
                            }
                        } else {
                            resultDiv.innerHTML = `
                                <div class="text-red-600 font-medium">运行失败:</div>
                                <div class="text-sm mt-1">${decision.runResult.error}</div>
                            `;
                        }
                    }
                }
            }
            
            function updateExecutionDisplay(executionDiv, status, output, feedback = '') {
                const taskIndex = executionDiv.id.split('-')[1];
                const resultDiv = document.getElementById(`result-${taskIndex}`);
                
                if (status === 'completed') {
                    resultDiv.innerHTML = `
                        <div class="text-green-600 font-medium mb-2">✅ 任务完成</div>
                        <div class="text-sm">${output || ''}</div>
                    `;
                } else if (status === 'failed') {
                    resultDiv.innerHTML = `
                        <div class="text-red-600 font-medium mb-2">❌ 任务失败</div>
                        <div class="text-sm mb-2">${output || ''}</div>
                        <div class="text-sm text-orange-600">反馈: ${feedback || ''}</div>
                    `;
                }
            }
            
            function updateSavedCodesDisplay() {
                savedCodesContainer.innerHTML = '';
                
                if (!savedCodes || savedCodes.length === 0) {
                    savedCodesContainer.innerHTML = '<div class="text-gray-500 text-sm">暂无保存的代码</div>';
                    return;
                }
                
                for (const codeInfo of savedCodes) {
                    const codeDiv = document.createElement('div');
                    codeDiv.className = 'saved-code-item';
                    codeDiv.dataset.codeId = codeInfo.id;
                    
                    codeDiv.innerHTML = `
                        <div class="font-medium">${codeInfo.name}</div>
                        <div class="text-xs text-gray-500">${new Date(codeInfo.created_at).toLocaleString()}</div>
                        <div class="text-xs text-gray-600 mt-1">代码长度: ${codeInfo.code.length} 字符</div>
                    `;
                    
                    codeDiv.addEventListener('click', () => {
                        // 选中代码
                        document.querySelectorAll('.saved-code-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        codeDiv.classList.add('selected');
                        selectedCodeId = codeInfo.id;
                    });
                    
                    savedCodesContainer.appendChild(codeDiv);
                }
                
                savedCodesSection.classList.remove('hidden');
            }
            
            function askForConfirmation(tool, query) { 
                return new Promise(resolve => { 
                    modalTool.textContent = tool; 
                    modalQuery.textContent = query; 
                    confirmationModal.classList.remove('hidden'); 
                    modalResolver = resolve; 
                }); 
            }
            
            approveBtn.addEventListener('click', () => { 
                if (modalResolver) { 
                    confirmationModal.classList.add('hidden'); 
                    modalResolver(true); 
                    modalResolver = null; 
                } 
            });
            
            rejectBtn.addEventListener('click', () => { 
                if (modalResolver) { 
                    confirmationModal.classList.add('hidden'); 
                    modalResolver(false); 
                    modalResolver = null; 
                } 
            });
            
            function initializeState() { 
                state = { 
                    apiKey: apiKeyInput.value.trim(), 
                    mainTask: mainTaskInput.value.trim(), 
                    plan: [], 
                    completedOutputs: [], 
                    isBusy: false, 
                }; 
                planSection.classList.add('hidden'); 
                executionSection.classList.add('hidden'); 
                logSection.classList.add('hidden'); 
                savedCodesSection.classList.add('hidden');
                finalResultSection.classList.add('hidden'); 
                finalReportSection.classList.add('hidden');
                planContainer.innerHTML = ''; 
                executionContainer.innerHTML = '';
                logContainer.innerHTML = ''; 
                savedCodesContainer.innerHTML = '';
                finalResultContainer.innerHTML = ''; 
                finalReportContent.innerHTML = '';
                savedCodes = {};
                selectedCodeId = null;
                executionHistory = [];
            }
            
            function validateInputs() { 
                if (!socket.connected) { 
                    alert("未连接到后端工具服务器。"); 
                    return false; 
                } 
                if (!state.apiKey) { 
                    alert("请输入API Key。"); 
                    return false; 
                } 
                if (!state.mainTask) { 
                    alert("请输入任务。"); 
                    return false; 
                } 
                return true; 
            }
            
            function setBusy(isBusy) { 
                state.isBusy = isBusy; 
                startButton.disabled = isBusy; 
                apiKeyInput.disabled = isBusy; 
                mainTaskInput.disabled = isBusy; 
                buttonLoader.classList.toggle('hidden', !isBusy); 
                buttonText.textContent = isBusy ? '正在运行...' : '开始任务'; 
            }
            
            function displayPlan() { 
                planContainer.innerHTML = ''; 
                state.plan.forEach((task, index) => { 
                    const taskDiv = document.createElement('div'); 
                    taskDiv.className = 'task-list-item p-3 bg-white border-l-4 rounded-r-md shadow-sm status-pending mb-2'; 
                    taskDiv.id = `task-item-${index}`; 
                    taskDiv.textContent = `${index + 1}. ${task}`; 
                    planContainer.appendChild(taskDiv); 
                }); 
                planSection.classList.remove('hidden'); 
            }
            
            function updateTaskStatus(taskId, status) { 
                const taskItem = document.getElementById(`task-item-${taskId}`); 
                if (taskItem) { 
                    taskItem.classList.remove('status-pending', 'status-running', 'status-completed', 'status-failed'); 
                    taskItem.classList.add(`status-${status}`); 
                } 
            }
            
            async function logStep(message, emoji = "➡️") { 
                return new Promise(resolve => { 
                    if (!logSection.classList.contains('hidden')) { 
                        logContainer.scrollTop = logContainer.scrollHeight; 
                    } else { 
                        logSection.classList.remove('hidden'); 
                    } 
                    const entry = document.createElement('div'); 
                    entry.className = 'log-entry opacity-0'; 
                    entry.innerHTML = `<span class="mr-2">${emoji}</span><span>${message.replace(/</g, "<").replace(/>/g, ">")}</span>`; 
                    logContainer.appendChild(entry); 
                    setTimeout(() => { 
                        entry.classList.remove('opacity-0'); 
                        logContainer.scrollTop = logContainer.scrollHeight; 
                        setTimeout(resolve, 50); 
                    }, 50); 
                }); 
            }
            
            async function handleFatalError(error) { 
                console.error("Agent 运行出错:", error); 
                await logStep(`发生严重错误，任务中止: ${error.message}`, "❌"); 
                setBusy(false); 
            }

            // --- DOM 事件监听 ---
            startButton.addEventListener('click', runAgent);
            mainTaskInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') runAgent(); });
            settingsButton.addEventListener('click', () => { settingsModal.classList.remove('hidden'); });
            closeSettingsBtn.addEventListener('click', () => { settingsModal.classList.add('hidden'); });
            saveSettingsBtn.addEventListener('click', () => { saveSettings(); settingsModal.classList.add('hidden'); });
            settingsModal.addEventListener('click', (e) => { if (e.target === settingsModal) { settingsModal.classList.add('hidden'); } });
            refreshSavedCodesBtn.addEventListener('click', loadSavedCodes);
            
            // 处理模型选择变化
            planningModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customPlanningModel.classList.remove('hidden');
                } else {
                    customPlanningModel.classList.add('hidden');
                }
            });
            
            executionModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customExecutionModel.classList.remove('hidden');
                } else {
                    customExecutionModel.classList.add('hidden');
                }
            });
            
            reviewModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customReviewModel.classList.remove('hidden');
                } else {
                    customReviewModel.classList.add('hidden');
                }
            });
            
            outputModel.addEventListener('change', (e) => {
                if (e.target.value === 'custom') {
                    customOutputModel.classList.remove('hidden');
                } else {
                    customOutputModel.classList.add('hidden');
                }
            });
            
            // 初始化时加载保存的代码
            loadSavedCodes();
            loadSettings();
        });
    </script>
</body>
</html>